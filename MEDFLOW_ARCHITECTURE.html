<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedFlow - System Architecture</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: #f8fafc; color: #1e293b; line-height: 1.6; }
    h1 { background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 50%, #8b5cf6 100%); color: white; padding: 40px; border-radius: 16px; margin-bottom: 30px; text-align: center; }
    h1 small { display: block; font-size: 14px; opacity: 0.9; margin-top: 10px; font-weight: normal; }
    h2 { color: #0f172a; margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 3px solid #e2e8f0; }
    h3 { color: #334155; margin: 20px 0 15px; }
    .section { background: white; padding: 30px; border-radius: 12px; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .grid { display: grid; gap: 20px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .card { background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #6366f1; }
    .card h4 { color: #4f46e5; margin-bottom: 10px; }
    .card ul { margin-left: 20px; }
    .card li { margin: 5px 0; }
    .stat-card { text-align: center; padding: 25px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; }
    .stat-card .number { font-size: 36px; font-weight: bold; color: #0284c7; }
    .stat-card .label { color: #64748b; font-size: 14px; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin: 2px; }
    .badge-critical { background: #fef2f2; color: #dc2626; }
    .badge-high { background: #fff7ed; color: #ea580c; }
    .badge-medium { background: #fefce8; color: #ca8a04; }
    .badge-low { background: #f0fdf4; color: #16a34a; }
    .badge-info { background: #eff6ff; color: #2563eb; }
    .tech-stack { display: flex; flex-wrap: wrap; gap: 10px; }
    .tech { background: #f1f5f9; padding: 8px 16px; border-radius: 6px; font-size: 13px; border: 1px solid #e2e8f0; }
    svg { max-width: 100%; height: auto; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f8fafc; font-weight: 600; color: #475569; }
    tr:hover { background: #f8fafc; }
    .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; }
    .issues-list { list-style: none; }
    .issues-list li { padding: 15px; margin: 10px 0; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444; }
    .issues-list li.high { background: #fff7ed; border-color: #f97316; }
    .issues-list li.medium { background: #fefce8; border-color: #eab308; }
    .toc { background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    .toc a { color: #4f46e5; text-decoration: none; display: block; padding: 5px 0; }
    .toc a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<h1>
  MedFlow - Medical Management System
  <small>Comprehensive Architecture & Audit Report | Generated: December 2025</small>
</h1>

<!-- Table of Contents -->
<div class="toc">
  <strong>Quick Navigation</strong>
  <div class="grid grid-4" style="margin-top: 15px;">
    <a href="#overview">1. System Overview</a>
    <a href="#architecture">2. Architecture</a>
    <a href="#data-flow">3. Data Flow</a>
    <a href="#tech-stack">4. Tech Stack</a>
    <a href="#security">5. Security Audit</a>
    <a href="#testing">6. Test Coverage</a>
    <a href="#issues">7. Issues Found</a>
    <a href="#action-plan">8. Action Plan</a>
  </div>
</div>

<!-- Section 1: System Overview -->
<div class="section" id="overview">
  <h2>1. System Overview</h2>

  <div class="grid grid-4" style="margin-bottom: 30px;">
    <div class="stat-card">
      <div class="number">351K+</div>
      <div class="label">Lines of Code</div>
    </div>
    <div class="stat-card">
      <div class="number">84</div>
      <div class="label">Database Models</div>
    </div>
    <div class="stat-card">
      <div class="number">78</div>
      <div class="label">API Routes</div>
    </div>
    <div class="stat-card">
      <div class="number">63+</div>
      <div class="label">Backend Services</div>
    </div>
  </div>

  <div class="grid grid-2">
    <div class="card">
      <h4>Business Objectives</h4>
      <ul>
        <li>Complete ophthalmology clinic management</li>
        <li>Multi-clinic operations with data sync</li>
        <li>Medical device integration (NIDEK, Zeiss, etc.)</li>
        <li>Electronic prescriptions & pharmacy</li>
        <li>Laboratory information system (LIS)</li>
        <li>Billing with multi-currency support</li>
        <li>Patient portal & appointments</li>
      </ul>
    </div>
    <div class="card">
      <h4>Target Users</h4>
      <ul>
        <li><strong>Doctors/Ophthalmologists:</strong> Clinical workflows, exams</li>
        <li><strong>Nurses:</strong> Vitals, queue management</li>
        <li><strong>Receptionists:</strong> Registration, appointments</li>
        <li><strong>Pharmacists:</strong> Dispensing, inventory</li>
        <li><strong>Lab Technicians:</strong> Orders, results</li>
        <li><strong>Accountants:</strong> Billing, reports</li>
        <li><strong>Patients:</strong> Portal access</li>
      </ul>
    </div>
  </div>
</div>

<!-- Section 2: Architecture Layers -->
<div class="section" id="architecture">
  <h2>2. System Architecture</h2>

  <svg viewBox="0 0 1000 600" style="background: #f8fafc; border-radius: 12px;">
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
        <path d="M0,0 L0,6 L9,3 z" fill="#64748b"/>
      </marker>
      <linearGradient id="blueGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#3b82f6"/>
        <stop offset="100%" style="stop-color:#1d4ed8"/>
      </linearGradient>
      <linearGradient id="greenGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#22c55e"/>
        <stop offset="100%" style="stop-color:#16a34a"/>
      </linearGradient>
      <linearGradient id="purpleGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#8b5cf6"/>
        <stop offset="100%" style="stop-color:#7c3aed"/>
      </linearGradient>
      <linearGradient id="orangeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#f97316"/>
        <stop offset="100%" style="stop-color:#ea580c"/>
      </linearGradient>
    </defs>

    <!-- Title -->
    <text x="500" y="35" text-anchor="middle" font-size="18" font-weight="bold" fill="#1e293b">MedFlow Architecture - Layered View</text>

    <!-- Frontend Layer -->
    <rect x="50" y="60" width="900" height="80" rx="8" fill="url(#blueGrad)" opacity="0.9"/>
    <text x="500" y="90" text-anchor="middle" fill="white" font-weight="bold" font-size="14">PRESENTATION LAYER (React 19 + Redux + Tailwind)</text>
    <text x="150" y="120" fill="white" font-size="11">Pages (124K LOC)</text>
    <text x="320" y="120" fill="white" font-size="11">Components (70+)</text>
    <text x="480" y="120" fill="white" font-size="11">Services (70+)</text>
    <text x="630" y="120" fill="white" font-size="11">Custom Hooks (16)</text>
    <text x="800" y="120" fill="white" font-size="11">Contexts (5)</text>

    <!-- API Gateway Layer -->
    <rect x="50" y="160" width="900" height="70" rx="8" fill="url(#purpleGrad)" opacity="0.9"/>
    <text x="500" y="190" text-anchor="middle" fill="white" font-weight="bold" font-size="14">API GATEWAY (Express.js + Middleware Stack)</text>
    <text x="150" y="215" fill="white" font-size="11">Auth (JWT+2FA)</text>
    <text x="300" y="215" fill="white" font-size="11">Rate Limiter</text>
    <text x="440" y="215" fill="white" font-size="11">Audit Logger</text>
    <text x="580" y="215" fill="white" font-size="11">Clinic Context</text>
    <text x="730" y="215" fill="white" font-size="11">Error Handler</text>
    <text x="870" y="215" fill="white" font-size="11">Metrics</text>

    <!-- Business Logic Layer -->
    <rect x="50" y="250" width="900" height="100" rx="8" fill="url(#orangeGrad)" opacity="0.9"/>
    <text x="500" y="280" text-anchor="middle" fill="white" font-weight="bold" font-size="14">BUSINESS LOGIC LAYER (Controllers + Services)</text>
    <text x="100" y="305" fill="white" font-size="10">Clinical</text>
    <text x="180" y="305" fill="white" font-size="10">Billing</text>
    <text x="260" y="305" fill="white" font-size="10">Pharmacy</text>
    <text x="350" y="305" fill="white" font-size="10">Laboratory</text>
    <text x="450" y="305" fill="white" font-size="10">Queue</text>
    <text x="530" y="305" fill="white" font-size="10">Devices</text>
    <text x="620" y="305" fill="white" font-size="10">Documents</text>
    <text x="720" y="305" fill="white" font-size="10">Notifications</text>
    <text x="830" y="305" fill="white" font-size="10">Sync</text>
    <text x="900" y="305" fill="white" font-size="10">Reports</text>
    <text x="500" y="335" text-anchor="middle" fill="white" font-size="11">59 Controllers (60K LOC) | 63 Services (33K LOC) | Device Adapters (17 types)</text>

    <!-- Data Layer -->
    <rect x="50" y="370" width="900" height="70" rx="8" fill="url(#greenGrad)" opacity="0.9"/>
    <text x="500" y="400" text-anchor="middle" fill="white" font-weight="bold" font-size="14">DATA LAYER (MongoDB + Redis + IndexedDB)</text>
    <text x="200" y="425" fill="white" font-size="11">84 Mongoose Models</text>
    <text x="400" y="425" fill="white" font-size="11">Redis Sessions/Cache</text>
    <text x="600" y="425" fill="white" font-size="11">Dexie Offline Store</text>
    <text x="800" y="425" fill="white" font-size="11">File Storage</text>

    <!-- External Integrations -->
    <rect x="50" y="460" width="900" height="70" rx="8" fill="#475569"/>
    <text x="500" y="490" text-anchor="middle" fill="white" font-weight="bold" font-size="14">EXTERNAL INTEGRATIONS</text>
    <text x="120" y="515" fill="white" font-size="11">SMB2 Shares</text>
    <text x="240" y="515" fill="white" font-size="11">Email (SMTP)</text>
    <text x="360" y="515" fill="white" font-size="11">SMS (Twilio)</text>
    <text x="480" y="515" fill="white" font-size="11">Google Calendar</text>
    <text x="620" y="515" fill="white" font-size="11">HL7/FHIR</text>
    <text x="730" y="515" fill="white" font-size="11">LIS</text>
    <text x="820" y="515" fill="white" font-size="11">Central Server</text>

    <!-- Real-time Layer -->
    <rect x="920" y="160" width="30" height="280" rx="4" fill="#ec4899"/>
    <text x="935" y="310" text-anchor="middle" fill="white" font-size="10" transform="rotate(-90 935 310)">WebSocket (Socket.io)</text>

    <!-- Arrows -->
    <path d="M500,140 L500,160" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
    <path d="M500,230 L500,250" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
    <path d="M500,350 L500,370" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
    <path d="M500,440 L500,460" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Legend -->
    <text x="60" y="560" font-size="11" fill="#64748b">Legend:</text>
    <rect x="120" y="548" width="15" height="15" fill="url(#blueGrad)"/>
    <text x="140" y="560" font-size="10" fill="#475569">Frontend</text>
    <rect x="200" y="548" width="15" height="15" fill="url(#purpleGrad)"/>
    <text x="220" y="560" font-size="10" fill="#475569">Middleware</text>
    <rect x="290" y="548" width="15" height="15" fill="url(#orangeGrad)"/>
    <text x="310" y="560" font-size="10" fill="#475569">Business Logic</text>
    <rect x="400" y="548" width="15" height="15" fill="url(#greenGrad)"/>
    <text x="420" y="560" font-size="10" fill="#475569">Data</text>
    <rect x="470" y="548" width="15" height="15" fill="#475569"/>
    <text x="490" y="560" font-size="10" fill="#475569">External</text>
    <rect x="550" y="548" width="15" height="15" fill="#ec4899"/>
    <text x="570" y="560" font-size="10" fill="#475569">Real-time</text>
  </svg>
</div>

<!-- Section 3: Data Flow -->
<div class="section" id="data-flow">
  <h2>3. Clinical Data Flow</h2>

  <svg viewBox="0 0 1000 400" style="background: #f8fafc; border-radius: 12px;">
    <defs>
      <marker id="arrow2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
        <path d="M0,0 L0,6 L9,3 z" fill="#64748b"/>
      </marker>
    </defs>

    <!-- Patient Entry -->
    <rect x="30" y="150" width="100" height="80" rx="8" fill="#3b82f6"/>
    <text x="80" y="185" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Patient</text>
    <text x="80" y="205" text-anchor="middle" fill="white" font-size="10">Registration</text>

    <!-- Queue -->
    <rect x="160" y="150" width="100" height="80" rx="8" fill="#8b5cf6"/>
    <text x="210" y="185" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Queue</text>
    <text x="210" y="205" text-anchor="middle" fill="white" font-size="10">Management</text>

    <!-- Clinical -->
    <rect x="290" y="100" width="120" height="50" rx="6" fill="#22c55e"/>
    <text x="350" y="130" text-anchor="middle" fill="white" font-size="11">Vitals Entry</text>

    <rect x="290" y="160" width="120" height="50" rx="6" fill="#22c55e"/>
    <text x="350" y="190" text-anchor="middle" fill="white" font-size="11">Consultation</text>

    <rect x="290" y="220" width="120" height="50" rx="6" fill="#22c55e"/>
    <text x="350" y="250" text-anchor="middle" fill="white" font-size="11">Examination</text>

    <!-- Outputs -->
    <rect x="440" y="80" width="110" height="50" rx="6" fill="#f97316"/>
    <text x="495" y="110" text-anchor="middle" fill="white" font-size="11">Prescription</text>

    <rect x="440" y="140" width="110" height="50" rx="6" fill="#f97316"/>
    <text x="495" y="170" text-anchor="middle" fill="white" font-size="11">Lab Orders</text>

    <rect x="440" y="200" width="110" height="50" rx="6" fill="#f97316"/>
    <text x="495" y="230" text-anchor="middle" fill="white" font-size="11">Imaging</text>

    <rect x="440" y="260" width="110" height="50" rx="6" fill="#f97316"/>
    <text x="495" y="290" text-anchor="middle" fill="white" font-size="11">Surgery</text>

    <!-- Processing -->
    <rect x="580" y="100" width="100" height="60" rx="6" fill="#ec4899"/>
    <text x="630" y="125" text-anchor="middle" fill="white" font-size="11">Pharmacy</text>
    <text x="630" y="145" text-anchor="middle" fill="white" font-size="9">Dispense</text>

    <rect x="580" y="170" width="100" height="60" rx="6" fill="#ec4899"/>
    <text x="630" y="195" text-anchor="middle" fill="white" font-size="11">Laboratory</text>
    <text x="630" y="215" text-anchor="middle" fill="white" font-size="9">Results</text>

    <rect x="580" y="240" width="100" height="60" rx="6" fill="#ec4899"/>
    <text x="630" y="265" text-anchor="middle" fill="white" font-size="11">Device Sync</text>
    <text x="630" y="285" text-anchor="middle" fill="white" font-size="9">NIDEK/Zeiss</text>

    <!-- Billing -->
    <rect x="710" y="150" width="100" height="80" rx="8" fill="#eab308"/>
    <text x="760" y="185" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Billing</text>
    <text x="760" y="205" text-anchor="middle" fill="white" font-size="10">Multi-Currency</text>

    <!-- Complete -->
    <rect x="840" y="150" width="110" height="80" rx="8" fill="#16a34a"/>
    <text x="895" y="180" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Complete</text>
    <text x="895" y="200" text-anchor="middle" fill="white" font-size="10">Documents</text>
    <text x="895" y="215" text-anchor="middle" fill="white" font-size="10">Reports</text>

    <!-- Arrows -->
    <path d="M130,190 L155,190" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M260,190 L285,190" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M410,125 L435,105" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M410,185 L435,165" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M410,185 L435,225" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M410,245 L435,285" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M550,105 L575,130" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M550,165 L575,200" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M550,225 L575,270" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M680,130 L705,170" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M680,200 L705,190" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M680,270 L705,210" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>
    <path d="M810,190 L835,190" stroke="#64748b" stroke-width="2" marker-end="url(#arrow2)"/>

    <!-- Legend -->
    <text x="50" y="350" font-size="11" font-weight="bold" fill="#475569">Clinical Workflow Stages:</text>
    <rect x="50" y="365" width="12" height="12" fill="#3b82f6"/>
    <text x="68" y="375" font-size="10" fill="#475569">Entry</text>
    <rect x="110" y="365" width="12" height="12" fill="#8b5cf6"/>
    <text x="128" y="375" font-size="10" fill="#475569">Triage</text>
    <rect x="170" y="365" width="12" height="12" fill="#22c55e"/>
    <text x="188" y="375" font-size="10" fill="#475569">Clinical</text>
    <rect x="240" y="365" width="12" height="12" fill="#f97316"/>
    <text x="258" y="375" font-size="10" fill="#475569">Orders</text>
    <rect x="300" y="365" width="12" height="12" fill="#ec4899"/>
    <text x="318" y="375" font-size="10" fill="#475569">Processing</text>
    <rect x="380" y="365" width="12" height="12" fill="#eab308"/>
    <text x="398" y="375" font-size="10" fill="#475569">Billing</text>
    <rect x="440" y="365" width="12" height="12" fill="#16a34a"/>
    <text x="458" y="375" font-size="10" fill="#475569">Complete</text>
  </svg>
</div>

<!-- Section 4: Tech Stack -->
<div class="section" id="tech-stack">
  <h2>4. Technology Stack</h2>

  <div class="grid grid-2">
    <div class="card">
      <h4>Backend (192K LOC)</h4>
      <div class="tech-stack">
        <span class="tech">Node.js 18+</span>
        <span class="tech">Express 4.18</span>
        <span class="tech">MongoDB 7+</span>
        <span class="tech">Mongoose 7.5</span>
        <span class="tech">Redis 4.6</span>
        <span class="tech">Socket.io 4.5</span>
        <span class="tech">JWT</span>
        <span class="tech">bcryptjs</span>
        <span class="tech">speakeasy (2FA)</span>
        <span class="tech">PDFKit</span>
        <span class="tech">Nodemailer</span>
        <span class="tech">SMB2</span>
        <span class="tech">Winston</span>
        <span class="tech">Helmet</span>
      </div>
    </div>
    <div class="card">
      <h4>Frontend (160K LOC)</h4>
      <div class="tech-stack">
        <span class="tech">React 19.1</span>
        <span class="tech">Redux Toolkit</span>
        <span class="tech">React Router 6</span>
        <span class="tech">Axios</span>
        <span class="tech">Socket.io-client</span>
        <span class="tech">Dexie (IndexedDB)</span>
        <span class="tech">Tailwind CSS 3.4</span>
        <span class="tech">Lucide Icons</span>
        <span class="tech">Recharts</span>
        <span class="tech">Yup</span>
        <span class="tech">date-fns</span>
        <span class="tech">Vite</span>
      </div>
    </div>
    <div class="card">
      <h4>Device Integration</h4>
      <div class="tech-stack">
        <span class="tech">NIDEK</span>
        <span class="tech">Zeiss</span>
        <span class="tech">Topcon</span>
        <span class="tech">OCT</span>
        <span class="tech">Autorefractor</span>
        <span class="tech">Tonometer</span>
        <span class="tech">Biometer</span>
        <span class="tech">Specular Microscope</span>
        <span class="tech">Visual Field</span>
        <span class="tech">Fundus Camera</span>
      </div>
    </div>
    <div class="card">
      <h4>Infrastructure</h4>
      <div class="tech-stack">
        <span class="tech">Multi-Clinic</span>
        <span class="tech">Offline-First</span>
        <span class="tech">WebSocket Real-time</span>
        <span class="tech">Redis Cache</span>
        <span class="tech">Rate Limiting</span>
        <span class="tech">Audit Logging</span>
        <span class="tech">2FA TOTP</span>
        <span class="tech">SMB2 File Shares</span>
      </div>
    </div>
  </div>
</div>

<!-- Section 5: Security Audit -->
<div class="section" id="security">
  <h2>5. Security Audit Findings</h2>

  <table>
    <thead>
      <tr>
        <th>Severity</th>
        <th>Issue</th>
        <th>Location</th>
        <th>Risk</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><span class="badge badge-critical">CRITICAL</span></td>
        <td>Path Traversal in File Uploads</td>
        <td>routes/uploads.js:284</td>
        <td>Arbitrary file access</td>
      </tr>
      <tr>
        <td><span class="badge badge-critical">CRITICAL</span></td>
        <td>XSS via dangerouslySetInnerHTML</td>
        <td>pages/templates/*.jsx</td>
        <td>Script injection</td>
      </tr>
      <tr>
        <td><span class="badge badge-high">HIGH</span></td>
        <td>Secrets in .env files (committed)</td>
        <td>backend/.env*</td>
        <td>Credential exposure</td>
      </tr>
      <tr>
        <td><span class="badge badge-high">HIGH</span></td>
        <td>Object.assign with user input</td>
        <td>23 controller files</td>
        <td>Prototype pollution</td>
      </tr>
      <tr>
        <td><span class="badge badge-high">HIGH</span></td>
        <td>Missing auth on file endpoint</td>
        <td>routes/uploads.js:263</td>
        <td>Unauthorized access</td>
      </tr>
      <tr>
        <td><span class="badge badge-medium">MEDIUM</span></td>
        <td>ReDoS via regex search</td>
        <td>patientController.js</td>
        <td>Denial of service</td>
      </tr>
      <tr>
        <td><span class="badge badge-medium">MEDIUM</span></td>
        <td>Permissive CORS for local network</td>
        <td>server.js:162</td>
        <td>Cross-origin attacks</td>
      </tr>
      <tr>
        <td><span class="badge badge-medium">MEDIUM</span></td>
        <td>Weak session fallback (Redis down)</td>
        <td>middleware/auth.js</td>
        <td>Session bypass</td>
      </tr>
    </tbody>
  </table>

  <h3>Positive Security Features</h3>
  <div class="grid grid-3">
    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
      <strong>JWT + Refresh Tokens</strong><br>
      <small>Proper token-based auth</small>
    </div>
    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
      <strong>2FA (TOTP)</strong><br>
      <small>Two-factor authentication</small>
    </div>
    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
      <strong>bcrypt Password Hashing</strong><br>
      <small>Secure password storage</small>
    </div>
    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
      <strong>Redis Rate Limiting</strong><br>
      <small>Distributed rate control</small>
    </div>
    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
      <strong>Audit Logging</strong><br>
      <small>Comprehensive request logging</small>
    </div>
    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
      <strong>Helmet Security Headers</strong><br>
      <small>Security headers configured</small>
    </div>
  </div>
</div>

<!-- Section 6: Test Coverage -->
<div class="section" id="testing">
  <h2>6. Test Coverage Analysis</h2>

  <div class="grid grid-4" style="margin-bottom: 30px;">
    <div class="stat-card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
      <div class="number" style="color: #dc2626;">&lt;1%</div>
      <div class="label">Overall Coverage</div>
    </div>
    <div class="stat-card">
      <div class="number">4</div>
      <div class="label">Test Files</div>
    </div>
    <div class="stat-card">
      <div class="number">~100</div>
      <div class="label">Test Cases</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
      <div class="number" style="color: #dc2626;">0</div>
      <div class="label">Frontend Tests</div>
    </div>
  </div>

  <h3>Test Status by Module</h3>
  <table>
    <thead>
      <tr>
        <th>Module</th>
        <th>Lines</th>
        <th>Tests</th>
        <th>Coverage</th>
        <th>Risk</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Authentication</td>
        <td>250+</td>
        <td>0</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 0%; background: #dc2626;"></div></div>
        </td>
        <td><span class="badge badge-critical">CRITICAL</span></td>
      </tr>
      <tr>
        <td>Billing/Financial</td>
        <td>6,655</td>
        <td>~25</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 1%; background: #dc2626;"></div></div>
        </td>
        <td><span class="badge badge-critical">CRITICAL</span></td>
      </tr>
      <tr>
        <td>Prescriptions</td>
        <td>4,737</td>
        <td>~20</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 5%; background: #f97316;"></div></div>
        </td>
        <td><span class="badge badge-high">HIGH</span></td>
      </tr>
      <tr>
        <td>Patient Management</td>
        <td>2,104</td>
        <td>~18</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 1%; background: #dc2626;"></div></div>
        </td>
        <td><span class="badge badge-high">HIGH</span></td>
      </tr>
      <tr>
        <td>Ophthalmology</td>
        <td>2,334</td>
        <td>0</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 0%; background: #dc2626;"></div></div>
        </td>
        <td><span class="badge badge-critical">CRITICAL</span></td>
      </tr>
      <tr>
        <td>Laboratory</td>
        <td>2,556</td>
        <td>0</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 0%; background: #dc2626;"></div></div>
        </td>
        <td><span class="badge badge-high">HIGH</span></td>
      </tr>
      <tr>
        <td>Queue Management</td>
        <td>1,341</td>
        <td>~20</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 5%; background: #f97316;"></div></div>
        </td>
        <td><span class="badge badge-medium">MEDIUM</span></td>
      </tr>
      <tr>
        <td>Services (all)</td>
        <td>32,531</td>
        <td>0</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 0%; background: #dc2626;"></div></div>
        </td>
        <td><span class="badge badge-critical">CRITICAL</span></td>
      </tr>
      <tr>
        <td>Frontend (React)</td>
        <td>160,000</td>
        <td>0</td>
        <td>
          <div class="progress-bar"><div class="progress-fill" style="width: 0%; background: #dc2626;"></div></div>
        </td>
        <td><span class="badge badge-high">HIGH</span></td>
      </tr>
    </tbody>
  </table>

  <h3>Test Execution Results</h3>
  <div style="background: #fef2f2; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px;">
    <strong>npm test output:</strong><br><br>
    FAIL tests/unit/invoiceCalculations.test.js<br>
    &nbsp;&nbsp;- ValidationError: Invoice validation failed (schema out of sync)<br>
    &nbsp;&nbsp;- createdBy: Path required, status: invalid enum, items: missing fields<br><br>
    <span style="color: #dc2626;">15 of 16 tests failing due to outdated test fixtures</span>
  </div>
</div>

<!-- Section 7: All Issues Found -->
<div class="section" id="issues">
  <h2>7. Complete Issues Summary</h2>

  <div class="grid grid-3" style="margin-bottom: 30px;">
    <div class="stat-card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
      <div class="number" style="color: #dc2626;">8</div>
      <div class="label">Critical Issues</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);">
      <div class="number" style="color: #ea580c;">12</div>
      <div class="label">High Issues</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #fefce8 0%, #fef08a 100%);">
      <div class="number" style="color: #ca8a04;">15</div>
      <div class="label">Medium Issues</div>
    </div>
  </div>

  <h3>Code Quality Issues</h3>
  <table>
    <thead>
      <tr>
        <th>Category</th>
        <th>Count</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Console.log Statements</td>
        <td>3,642</td>
        <td>Debug statements in production code</td>
      </tr>
      <tr>
        <td>Empty Catch Blocks</td>
        <td>10+</td>
        <td>Silent error swallowing (SMB, import scripts)</td>
      </tr>
      <tr>
        <td>Unused Variables</td>
        <td>50+</td>
        <td>ESLint no-unused-vars violations</td>
      </tr>
      <tr>
        <td>Missing Input Validation</td>
        <td>~800</td>
        <td>890 req.body usages vs 76 validations</td>
      </tr>
      <tr>
        <td>Large Files</td>
        <td>8</td>
        <td>Components/controllers &gt;2000 lines</td>
      </tr>
      <tr>
        <td>Build Warnings</td>
        <td>1</td>
        <td>Bundle &gt;500KB (812KB main chunk)</td>
      </tr>
    </tbody>
  </table>

  <h3>Architecture Issues</h3>
  <ul class="issues-list">
    <li>
      <strong>Visit.js model is 1,666 lines</strong> - Overly complex, should be split into smaller focused models
    </li>
    <li class="high">
      <strong>63+ services with overlapping responsibilities</strong> - Consider domain grouping (clinical/, billing/, integration/)
    </li>
    <li class="medium">
      <strong>No API versioning</strong> - All routes use /api/ without v1/v2 prefix
    </li>
    <li class="medium">
      <strong>Missing dependency injection</strong> - Manual service imports make testing harder
    </li>
    <li class="medium">
      <strong>Legacy fields scattered across models</strong> - Should use dedicated LegacyMapping model
    </li>
  </ul>
</div>

<!-- Section 8: Action Plan -->
<div class="section" id="action-plan">
  <h2>8. Prioritized Action Plan</h2>

  <h3><span class="badge badge-critical">PHASE 1: IMMEDIATE</span> Critical Security & Tests</h3>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Task</th>
        <th>File(s)</th>
        <th>Effort</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>1</td>
        <td>Fix path traversal in file uploads</td>
        <td>routes/uploads.js</td>
        <td>4h</td>
      </tr>
      <tr>
        <td>2</td>
        <td>Add DOMPurify sanitization for templates</td>
        <td>pages/templates/*.jsx</td>
        <td>4h</td>
      </tr>
      <tr>
        <td>3</td>
        <td>Remove .env files from git, use .env.example</td>
        <td>backend/.env*</td>
        <td>2h</td>
      </tr>
      <tr>
        <td>4</td>
        <td>Add auth middleware to file endpoint</td>
        <td>routes/uploads.js:263</td>
        <td>1h</td>
      </tr>
      <tr>
        <td>5</td>
        <td>Fix Object.assign prototype pollution (23 files)</td>
        <td>controllers/*.js</td>
        <td>8h</td>
      </tr>
      <tr>
        <td>6</td>
        <td>Fix failing tests (update fixtures)</td>
        <td>tests/fixtures/generators.js</td>
        <td>4h</td>
      </tr>
    </tbody>
  </table>

  <h3><span class="badge badge-high">PHASE 2: SHORT TERM</span> Testing & Validation</h3>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Task</th>
        <th>Estimated Hours</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>7</td>
        <td>Write authentication tests (login, register, 2FA, tokens)</td>
        <td>80h</td>
      </tr>
      <tr>
        <td>8</td>
        <td>Write billing/financial tests</td>
        <td>120h</td>
      </tr>
      <tr>
        <td>9</td>
        <td>Add input validation middleware to all endpoints</td>
        <td>40h</td>
      </tr>
      <tr>
        <td>10</td>
        <td>Add ReDoS protection to regex searches</td>
        <td>8h</td>
      </tr>
      <tr>
        <td>11</td>
        <td>Write prescription safety tests</td>
        <td>100h</td>
      </tr>
    </tbody>
  </table>

  <h3><span class="badge badge-medium">PHASE 3: MEDIUM TERM</span> Code Quality & Architecture</h3>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Task</th>
        <th>Estimated Hours</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>12</td>
        <td>Remove console.log statements (3,642 occurrences)</td>
        <td>16h</td>
      </tr>
      <tr>
        <td>13</td>
        <td>Fix empty catch blocks</td>
        <td>4h</td>
      </tr>
      <tr>
        <td>14</td>
        <td>Refactor large model files (Visit.js)</td>
        <td>24h</td>
      </tr>
      <tr>
        <td>15</td>
        <td>Implement API versioning (/api/v1/)</td>
        <td>16h</td>
      </tr>
      <tr>
        <td>16</td>
        <td>Code-split large frontend bundle</td>
        <td>8h</td>
      </tr>
      <tr>
        <td>17</td>
        <td>Write frontend component tests</td>
        <td>150h</td>
      </tr>
      <tr>
        <td>18</td>
        <td>Add E2E workflow tests</td>
        <td>100h</td>
      </tr>
    </tbody>
  </table>

  <h3>Total Effort Estimation</h3>
  <div class="grid grid-3">
    <div class="stat-card">
      <div class="number">23h</div>
      <div class="label">Phase 1 (Critical)</div>
    </div>
    <div class="stat-card">
      <div class="number">348h</div>
      <div class="label">Phase 2 (Testing)</div>
    </div>
    <div class="stat-card">
      <div class="number">318h</div>
      <div class="label">Phase 3 (Quality)</div>
    </div>
  </div>

  <div style="margin-top: 30px; padding: 20px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
    <strong>Recommendation:</strong> Phase 1 should be completed before any production deployment. Phase 2 should be prioritized for healthcare compliance (HIPAA, GDPR). Phase 3 improves long-term maintainability.
  </div>
</div>

<footer style="text-align: center; padding: 40px; color: #64748b; font-size: 12px;">
  <p>MedFlow Architecture & Audit Report | Generated by Claude Code | December 2025</p>
  <p>Backend: 192K LOC | Frontend: 160K LOC | 84 Models | 78 Routes | 63 Services</p>
</footer>

</body>
</html>