<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedFlow - Complete Architecture & Data Flow</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; }

    .header { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #3730a3 100%); color: white; padding: 40px 20px; text-align: center; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 1.1rem; }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .section { background: white; border-radius: 16px; padding: 30px; margin: 30px 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .section h2 { color: #1e3a8a; border-bottom: 3px solid #3730a3; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5rem; }
    .section h3 { color: #475569; margin: 20px 0 10px; font-size: 1.2rem; }

    .grid { display: grid; gap: 20px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    .card { background: linear-gradient(145deg, #f1f5f9, #e2e8f0); border-radius: 12px; padding: 20px; border-left: 4px solid #3730a3; }
    .card.blue { border-left-color: #3b82f6; background: linear-gradient(145deg, #eff6ff, #dbeafe); }
    .card.green { border-left-color: #10b981; background: linear-gradient(145deg, #ecfdf5, #d1fae5); }
    .card.orange { border-left-color: #f59e0b; background: linear-gradient(145deg, #fffbeb, #fef3c7); }
    .card.red { border-left-color: #ef4444; background: linear-gradient(145deg, #fef2f2, #fee2e2); }
    .card.purple { border-left-color: #8b5cf6; background: linear-gradient(145deg, #f5f3ff, #ede9fe); }
    .card h4 { color: #1e293b; margin-bottom: 10px; font-size: 1.1rem; }
    .card ul { margin-left: 20px; color: #475569; }
    .card li { margin: 5px 0; }

    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin: 2px; }
    .badge.primary { background: #3730a3; color: white; }
    .badge.success { background: #10b981; color: white; }
    .badge.warning { background: #f59e0b; color: white; }
    .badge.info { background: #3b82f6; color: white; }

    svg { max-width: 100%; height: auto; }
    .svg-container { overflow-x: auto; padding: 20px 0; }

    .flow-step { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8fafc; border-radius: 8px; margin: 10px 0; }
    .flow-step .number { width: 30px; height: 30px; background: #3730a3; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }

    .code-ref { font-family: 'SF Mono', Monaco, monospace; font-size: 0.85rem; color: #6366f1; background: #eef2ff; padding: 2px 6px; border-radius: 4px; }

    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f1f5f9; font-weight: 600; color: #1e293b; }
    tr:hover { background: #f8fafc; }

    .alert { padding: 15px 20px; border-radius: 8px; margin: 15px 0; }
    .alert.info { background: #eff6ff; border: 1px solid #3b82f6; color: #1e40af; }
    .alert.warning { background: #fffbeb; border: 1px solid #f59e0b; color: #92400e; }
    .alert.success { background: #ecfdf5; border: 1px solid #10b981; color: #065f46; }

    .metric { text-align: center; padding: 20px; }
    .metric .value { font-size: 2.5rem; font-weight: bold; color: #3730a3; }
    .metric .label { color: #64748b; font-size: 0.9rem; }
  </style>
</head>
<body>

<div class="header">
  <h1>MedFlow EMR System</h1>
  <p>Complete Architecture, Data Flow & Business Logic Documentation</p>
  <p style="margin-top: 15px;">
    <span class="badge primary">Node.js/Express</span>
    <span class="badge info">MongoDB</span>
    <span class="badge success">React/Redux</span>
    <span class="badge warning">Socket.IO</span>
  </p>
</div>

<div class="container">

<!-- BUSINESS CONTEXT -->
<div class="section">
  <h2>1. Business Context & Objectives</h2>

  <div class="grid grid-4">
    <div class="metric">
      <div class="value">84</div>
      <div class="label">MongoDB Models</div>
    </div>
    <div class="metric">
      <div class="value">185</div>
      <div class="label">Frontend Pages</div>
    </div>
    <div class="metric">
      <div class="value">79</div>
      <div class="label">API Services</div>
    </div>
    <div class="metric">
      <div class="value">12</div>
      <div class="label">Clinical Workflow Steps</div>
    </div>
  </div>

  <div class="grid grid-2" style="margin-top: 30px;">
    <div class="card blue">
      <h4>Primary Objectives</h4>
      <ul>
        <li><strong>Ophthalmology EMR</strong> - Comprehensive eye care management</li>
        <li><strong>Multi-Clinic Support</strong> - Centralized data across locations</li>
        <li><strong>Convention Billing</strong> - Corporate/insurance coverage automation</li>
        <li><strong>Inventory Management</strong> - Pharmacy, frames, lenses, reagents</li>
        <li><strong>Real-time Queue</strong> - WebSocket-driven patient flow</li>
      </ul>
    </div>
    <div class="card green">
      <h4>Key Users</h4>
      <ul>
        <li><strong>Ophthalmologists</strong> - Clinical exams, prescriptions, IVT</li>
        <li><strong>Optometrists</strong> - Refraction, contact lens fitting</li>
        <li><strong>Reception</strong> - Check-in, appointments, queue</li>
        <li><strong>Pharmacists</strong> - Dispensing, inventory</li>
        <li><strong>Accountants</strong> - Invoicing, convention billing</li>
        <li><strong>Lab Technicians</strong> - Lab orders, results</li>
      </ul>
    </div>
  </div>
</div>

<!-- MAIN CLINICAL WORKFLOW -->
<div class="section">
  <h2>2. Primary Clinical Workflow - Patient Journey</h2>

  <div class="svg-container">
    <svg viewBox="0 0 1200 450" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#64748b"/>
        </marker>
        <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6"/>
        </marker>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#3b82f6"/>
          <stop offset="100%" style="stop-color:#1d4ed8"/>
        </linearGradient>
        <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#f59e0b"/>
          <stop offset="100%" style="stop-color:#d97706"/>
        </linearGradient>
        <linearGradient id="grad3" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#8b5cf6"/>
          <stop offset="100%" style="stop-color:#6d28d9"/>
        </linearGradient>
        <linearGradient id="grad4" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#10b981"/>
          <stop offset="100%" style="stop-color:#059669"/>
        </linearGradient>
        <linearGradient id="grad5" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#ef4444"/>
          <stop offset="100%" style="stop-color:#dc2626"/>
        </linearGradient>
      </defs>

      <!-- Background -->
      <rect x="0" y="0" width="1200" height="450" fill="#f8fafc"/>

      <!-- Stage 1: Arrival -->
      <rect x="30" y="80" width="160" height="100" rx="12" fill="url(#grad1)"/>
      <text x="110" y="120" text-anchor="middle" fill="white" font-weight="bold" font-size="14">ARRIVAL</text>
      <text x="110" y="145" text-anchor="middle" fill="white" font-size="11">Appointment / Walk-in</text>
      <text x="110" y="165" text-anchor="middle" fill="#dbeafe" font-size="10">Patient.find() | Appointment.create()</text>

      <!-- Stage 2: Check-in -->
      <rect x="230" y="80" width="160" height="100" rx="12" fill="url(#grad2)"/>
      <text x="310" y="120" text-anchor="middle" fill="white" font-weight="bold" font-size="14">CHECK-IN</text>
      <text x="310" y="145" text-anchor="middle" fill="white" font-size="11">Queue + Visit Created</text>
      <text x="310" y="165" text-anchor="middle" fill="#fef3c7" font-size="10">Visit.captureConventionSnapshot()</text>

      <!-- Stage 3: Consultation -->
      <rect x="430" y="80" width="180" height="100" rx="12" fill="url(#grad3)"/>
      <text x="520" y="115" text-anchor="middle" fill="white" font-weight="bold" font-size="14">CONSULTATION</text>
      <text x="520" y="140" text-anchor="middle" fill="white" font-size="11">12-Step Clinical Workflow</text>
      <text x="520" y="160" text-anchor="middle" fill="#ede9fe" font-size="10">ConsultationSession + OphthalmologyExam</text>

      <!-- Stage 4: Billing -->
      <rect x="650" y="80" width="160" height="100" rx="12" fill="url(#grad4)"/>
      <text x="730" y="120" text-anchor="middle" fill="white" font-weight="bold" font-size="14">BILLING</text>
      <text x="730" y="145" text-anchor="middle" fill="white" font-size="11">Invoice Generation</text>
      <text x="730" y="165" text-anchor="middle" fill="#d1fae5" font-size="10">Visit.generateInvoice()</text>

      <!-- Stage 5: Dispensing -->
      <rect x="850" y="80" width="160" height="100" rx="12" fill="url(#grad5)"/>
      <text x="930" y="120" text-anchor="middle" fill="white" font-weight="bold" font-size="14">DISPENSING</text>
      <text x="930" y="145" text-anchor="middle" fill="white" font-size="11">Pharmacy / Optical</text>
      <text x="930" y="165" text-anchor="middle" fill="#fee2e2" font-size="10">Prescription.dispense()</text>

      <!-- Completion -->
      <rect x="1050" y="100" width="80" height="60" rx="30" fill="#22c55e"/>
      <text x="1090" y="135" text-anchor="middle" fill="white" font-weight="bold" font-size="12">DONE</text>

      <!-- Arrows -->
      <path d="M190,130 L225,130" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>
      <path d="M390,130 L425,130" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>
      <path d="M610,130 L645,130" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>
      <path d="M810,130 L845,130" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>
      <path d="M1010,130 L1045,130" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>

      <!-- Sub-processes -->
      <!-- Check-in Details -->
      <rect x="230" y="210" width="160" height="80" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
      <text x="310" y="235" text-anchor="middle" fill="#92400e" font-weight="600" font-size="11">Convention Snapshot</text>
      <text x="310" y="255" text-anchor="middle" fill="#92400e" font-size="10">Coverage % locked at check-in</text>
      <text x="310" y="275" text-anchor="middle" fill="#92400e" font-size="10">Prevents mid-visit price changes</text>
      <path d="M310,180 L310,205" stroke="#f59e0b" stroke-width="2" stroke-dasharray="4"/>

      <!-- Consultation Details -->
      <rect x="430" y="210" width="180" height="120" rx="8" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
      <text x="520" y="235" text-anchor="middle" fill="#5b21b6" font-weight="600" font-size="11">Clinical Acts Recorded</text>
      <text x="520" y="255" text-anchor="middle" fill="#5b21b6" font-size="10">Visual Acuity, Refraction</text>
      <text x="520" y="275" text-anchor="middle" fill="#5b21b6" font-size="10">IOP, Slit Lamp, Fundus</text>
      <text x="520" y="295" text-anchor="middle" fill="#5b21b6" font-size="10">Diagnoses (ICD-10)</text>
      <text x="520" y="315" text-anchor="middle" fill="#5b21b6" font-size="10">Prescriptions Created</text>
      <path d="M520,180 L520,205" stroke="#8b5cf6" stroke-width="2" stroke-dasharray="4"/>

      <!-- Billing Details -->
      <rect x="650" y="210" width="160" height="100" rx="8" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
      <text x="730" y="235" text-anchor="middle" fill="#065f46" font-weight="600" font-size="11">Invoice Items</text>
      <text x="730" y="255" text-anchor="middle" fill="#065f46" font-size="10">Consultation Fee</text>
      <text x="730" y="275" text-anchor="middle" fill="#065f46" font-size="10">Clinical Acts (exams)</text>
      <text x="730" y="295" text-anchor="middle" fill="#065f46" font-size="10">Convention Split Applied</text>
      <path d="M730,180 L730,205" stroke="#10b981" stroke-width="2" stroke-dasharray="4"/>

      <!-- WebSocket Events -->
      <rect x="30" y="360" width="980" height="70" rx="8" fill="#1e3a8a" opacity="0.1"/>
      <text x="520" y="385" text-anchor="middle" fill="#1e3a8a" font-weight="bold" font-size="12">WebSocket Real-Time Events (Socket.IO)</text>
      <text x="150" y="410" text-anchor="middle" fill="#1e3a8a" font-size="10">patient_checked_in</text>
      <text x="310" y="410" text-anchor="middle" fill="#1e3a8a" font-size="10">queue_update</text>
      <text x="520" y="410" text-anchor="middle" fill="#1e3a8a" font-size="10">patient_called</text>
      <text x="730" y="410" text-anchor="middle" fill="#1e3a8a" font-size="10">billing_update</text>
      <text x="930" y="410" text-anchor="middle" fill="#1e3a8a" font-size="10">prescription_ready</text>
    </svg>
  </div>

  <div class="alert info">
    <strong>Critical Business Rule:</strong> Medications are NOT included in Visit invoices to prevent double-billing.
    Prescriptions generate separate invoices when dispensed at pharmacy.
    <span class="code-ref">Visit.js:1395-1400</span>
  </div>
</div>

<!-- DATA MODEL RELATIONSHIPS -->
<div class="section">
  <h2>3. Core Data Model Relationships</h2>

  <div class="svg-container">
    <svg viewBox="0 0 1100 500" xmlns="http://www.w3.org/2000/svg">
      <!-- Background -->
      <rect x="0" y="0" width="1100" height="500" fill="#f8fafc"/>

      <!-- Patient (Center) -->
      <rect x="450" y="180" width="200" height="140" rx="10" fill="#3b82f6" stroke="#1d4ed8" stroke-width="2"/>
      <text x="550" y="210" text-anchor="middle" fill="white" font-weight="bold" font-size="16">Patient</text>
      <text x="550" y="235" text-anchor="middle" fill="#dbeafe" font-size="11">patientId (PAT2024000001)</text>
      <text x="550" y="255" text-anchor="middle" fill="#dbeafe" font-size="11">convention: { company, coverage% }</text>
      <text x="550" y="275" text-anchor="middle" fill="#dbeafe" font-size="11">accountBalance: { outstanding }</text>
      <text x="550" y="295" text-anchor="middle" fill="#dbeafe" font-size="11">faceEncoding (biometric)</text>

      <!-- Appointment -->
      <rect x="50" y="50" width="180" height="100" rx="8" fill="#f59e0b" stroke="#d97706" stroke-width="2"/>
      <text x="140" y="80" text-anchor="middle" fill="white" font-weight="bold" font-size="14">Appointment</text>
      <text x="140" y="100" text-anchor="middle" fill="#fef3c7" font-size="10">date, startTime, provider</text>
      <text x="140" y="120" text-anchor="middle" fill="#fef3c7" font-size="10">status, queueNumber</text>
      <text x="140" y="140" text-anchor="middle" fill="#fef3c7" font-size="10">visit (ref) ↔ bidirectional</text>

      <!-- Visit -->
      <rect x="50" y="200" width="180" height="120" rx="8" fill="#8b5cf6" stroke="#6d28d9" stroke-width="2"/>
      <text x="140" y="230" text-anchor="middle" fill="white" font-weight="bold" font-size="14">Visit</text>
      <text x="140" y="250" text-anchor="middle" fill="#ede9fe" font-size="10">visitId (VIS20241201001)</text>
      <text x="140" y="270" text-anchor="middle" fill="#ede9fe" font-size="10">clinicalActs[], diagnoses[]</text>
      <text x="140" y="290" text-anchor="middle" fill="#ede9fe" font-size="10">billing.conventionSnapshot</text>
      <text x="140" y="310" text-anchor="middle" fill="#ede9fe" font-size="10">prescriptions[], ivtTreatments[]</text>

      <!-- ConsultationSession -->
      <rect x="50" y="360" width="180" height="90" rx="8" fill="#ec4899" stroke="#be185d" stroke-width="2"/>
      <text x="140" y="390" text-anchor="middle" fill="white" font-weight="bold" font-size="14">ConsultationSession</text>
      <text x="140" y="410" text-anchor="middle" fill="#fce7f3" font-size="10">sessionType, stepData</text>
      <text x="140" y="430" text-anchor="middle" fill="#fce7f3" font-size="10">refraction, orthoptic data</text>

      <!-- Invoice -->
      <rect x="870" y="50" width="180" height="120" rx="8" fill="#10b981" stroke="#059669" stroke-width="2"/>
      <text x="960" y="80" text-anchor="middle" fill="white" font-weight="bold" font-size="14">Invoice</text>
      <text x="960" y="100" text-anchor="middle" fill="#d1fae5" font-size="10">invoiceId (INV2024000001)</text>
      <text x="960" y="120" text-anchor="middle" fill="#d1fae5" font-size="10">items[].companyShare</text>
      <text x="960" y="140" text-anchor="middle" fill="#d1fae5" font-size="10">items[].patientShare</text>
      <text x="960" y="160" text-anchor="middle" fill="#d1fae5" font-size="10">payments[], status</text>

      <!-- Prescription -->
      <rect x="870" y="200" width="180" height="100" rx="8" fill="#ef4444" stroke="#dc2626" stroke-width="2"/>
      <text x="960" y="230" text-anchor="middle" fill="white" font-weight="bold" font-size="14">Prescription</text>
      <text x="960" y="250" text-anchor="middle" fill="#fee2e2" font-size="10">type: medication|optical</text>
      <text x="960" y="270" text-anchor="middle" fill="#fee2e2" font-size="10">medications[].reservedQty</text>
      <text x="960" y="290" text-anchor="middle" fill="#fee2e2" font-size="10">pharmacyStatus, dispensedAt</text>

      <!-- Company (Convention) -->
      <rect x="870" y="340" width="180" height="100" rx="8" fill="#6366f1" stroke="#4f46e5" stroke-width="2"/>
      <text x="960" y="370" text-anchor="middle" fill="white" font-weight="bold" font-size="14">Company</text>
      <text x="960" y="390" text-anchor="middle" fill="#e0e7ff" font-size="10">Convention/Corporate</text>
      <text x="960" y="410" text-anchor="middle" fill="#e0e7ff" font-size="10">defaultCoverage.percentage</text>
      <text x="960" y="430" text-anchor="middle" fill="#e0e7ff" font-size="10">packageDeals[], coveredCategories</text>

      <!-- PharmacyInventory -->
      <rect x="450" y="380" width="200" height="80" rx="8" fill="#14b8a6" stroke="#0d9488" stroke-width="2"/>
      <text x="550" y="410" text-anchor="middle" fill="white" font-weight="bold" font-size="14">PharmacyInventory</text>
      <text x="550" y="430" text-anchor="middle" fill="#ccfbf1" font-size="10">currentStock, reserved, batches[]</text>
      <text x="550" y="450" text-anchor="middle" fill="#ccfbf1" font-size="10">clinic (multi-clinic isolation)</text>

      <!-- Relationship Lines -->
      <!-- Patient to Appointment -->
      <path d="M450,220 L230,120" stroke="#64748b" stroke-width="2" fill="none"/>
      <text x="340" y="160" fill="#64748b" font-size="10">has many</text>

      <!-- Patient to Visit -->
      <path d="M450,250 L230,260" stroke="#64748b" stroke-width="2" fill="none"/>
      <text x="340" y="245" fill="#64748b" font-size="10">has many</text>

      <!-- Appointment to Visit -->
      <path d="M140,150 L140,195" stroke="#f59e0b" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
      <text x="155" y="175" fill="#f59e0b" font-size="9">creates →</text>

      <!-- Visit to ConsultationSession -->
      <path d="M140,320 L140,355" stroke="#64748b" stroke-width="2" fill="none"/>
      <text x="155" y="340" fill="#64748b" font-size="9">has one</text>

      <!-- Patient to Invoice -->
      <path d="M650,220 L870,110" stroke="#64748b" stroke-width="2" fill="none"/>
      <text x="760" y="155" fill="#64748b" font-size="10">has many</text>

      <!-- Patient to Prescription -->
      <path d="M650,260 L870,250" stroke="#64748b" stroke-width="2" fill="none"/>
      <text x="760" y="245" fill="#64748b" font-size="10">has many</text>

      <!-- Patient to Company -->
      <path d="M650,300 L870,380" stroke="#6366f1" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
      <text x="760" y="350" fill="#6366f1" font-size="10">convention.company</text>

      <!-- Prescription to Inventory -->
      <path d="M870,280 L650,400" stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
      <text x="760" y="355" fill="#ef4444" font-size="10">reserves stock</text>

      <!-- Visit to Invoice -->
      <path d="M230,240 C400,180 700,80 870,100" stroke="#10b981" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
      <text x="520" y="100" fill="#10b981" font-size="10">generateInvoice()</text>
    </svg>
  </div>
</div>

<!-- CONVENTION BILLING FLOW -->
<div class="section">
  <h2>4. Convention/Insurance Billing Flow</h2>

  <div class="alert warning">
    <strong>Business Critical:</strong> Convention snapshot is captured at check-in time to prevent pricing manipulation.
    If patient's coverage changes after check-in, the original snapshot is used for billing.
  </div>

  <div class="svg-container">
    <svg viewBox="0 0 1000 350" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="1000" height="350" fill="#f8fafc"/>

      <!-- Step 1: Check-in -->
      <rect x="50" y="50" width="180" height="80" rx="8" fill="#3b82f6"/>
      <text x="140" y="85" text-anchor="middle" fill="white" font-weight="bold" font-size="13">1. Check-in</text>
      <text x="140" y="105" text-anchor="middle" fill="#dbeafe" font-size="10">captureConventionSnapshot()</text>
      <text x="140" y="120" text-anchor="middle" fill="#dbeafe" font-size="10">Visit.js:766-815</text>

      <!-- Snapshot Box -->
      <rect x="50" y="150" width="180" height="90" rx="6" fill="#eff6ff" stroke="#3b82f6" stroke-width="1"/>
      <text x="140" y="175" text-anchor="middle" fill="#1e40af" font-weight="600" font-size="11">Snapshot Captures:</text>
      <text x="140" y="195" text-anchor="middle" fill="#1e40af" font-size="10">- Company ID & Name</text>
      <text x="140" y="210" text-anchor="middle" fill="#1e40af" font-size="10">- Coverage % at check-in</text>
      <text x="140" y="225" text-anchor="middle" fill="#1e40af" font-size="10">- Coverage rules snapshot</text>

      <!-- Step 2: Invoice Creation -->
      <rect x="280" y="50" width="180" height="80" rx="8" fill="#f59e0b"/>
      <text x="370" y="85" text-anchor="middle" fill="white" font-weight="bold" font-size="13">2. Invoice Creation</text>
      <text x="370" y="105" text-anchor="middle" fill="#fef3c7" font-size="10">applyPackageDeals()</text>
      <text x="370" y="120" text-anchor="middle" fill="#fef3c7" font-size="10">invoiceController.js:383-496</text>

      <!-- Package Detection -->
      <rect x="280" y="150" width="180" height="90" rx="6" fill="#fffbeb" stroke="#f59e0b" stroke-width="1"/>
      <text x="370" y="175" text-anchor="middle" fill="#92400e" font-weight="600" font-size="11">Package Deal Detection:</text>
      <text x="370" y="195" text-anchor="middle" fill="#92400e" font-size="10">- Match acts to packages</text>
      <text x="370" y="210" text-anchor="middle" fill="#92400e" font-size="10">- Bundle into package price</text>
      <text x="370" y="225" text-anchor="middle" fill="#92400e" font-size="10">- Calculate savings</text>

      <!-- Step 3: Coverage Split -->
      <rect x="510" y="50" width="180" height="80" rx="8" fill="#8b5cf6"/>
      <text x="600" y="85" text-anchor="middle" fill="white" font-weight="bold" font-size="13">3. Coverage Split</text>
      <text x="600" y="105" text-anchor="middle" fill="#ede9fe" font-size="10">Per-item calculation</text>
      <text x="600" y="120" text-anchor="middle" fill="#ede9fe" font-size="10">invoiceController.js:825-964</text>

      <!-- Split Calculation -->
      <rect x="510" y="150" width="180" height="90" rx="6" fill="#f5f3ff" stroke="#8b5cf6" stroke-width="1"/>
      <text x="600" y="175" text-anchor="middle" fill="#5b21b6" font-weight="600" font-size="11">For Each Item:</text>
      <text x="600" y="195" text-anchor="middle" fill="#5b21b6" font-size="10">- Check category coverage</text>
      <text x="600" y="210" text-anchor="middle" fill="#5b21b6" font-size="10">- Check approval required</text>
      <text x="600" y="225" text-anchor="middle" fill="#5b21b6" font-size="10">- Apply max per category</text>

      <!-- Step 4: Result -->
      <rect x="740" y="50" width="180" height="80" rx="8" fill="#10b981"/>
      <text x="830" y="85" text-anchor="middle" fill="white" font-weight="bold" font-size="13">4. Final Invoice</text>
      <text x="830" y="105" text-anchor="middle" fill="#d1fae5" font-size="10">companyShare + patientShare</text>
      <text x="830" y="120" text-anchor="middle" fill="#d1fae5" font-size="10">= total</text>

      <!-- Result Box -->
      <rect x="740" y="150" width="180" height="90" rx="6" fill="#ecfdf5" stroke="#10b981" stroke-width="1"/>
      <text x="830" y="175" text-anchor="middle" fill="#065f46" font-weight="600" font-size="11">Invoice Contains:</text>
      <text x="830" y="195" text-anchor="middle" fill="#065f46" font-size="10">item.companyShare (80%)</text>
      <text x="830" y="210" text-anchor="middle" fill="#065f46" font-size="10">item.patientShare (20%)</text>
      <text x="830" y="225" text-anchor="middle" fill="#065f46" font-size="10">Patient pays patientShare only</text>

      <!-- Arrows -->
      <path d="M230,90 L275,90" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
      <path d="M460,90 L505,90" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
      <path d="M690,90 L735,90" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

      <!-- Bottom: Annual Usage Tracking -->
      <rect x="280" y="280" width="440" height="50" rx="8" fill="#1e3a8a" opacity="0.1"/>
      <text x="500" y="305" text-anchor="middle" fill="#1e3a8a" font-weight="bold" font-size="12">Patient.convention.annualUsage Updated</text>
      <text x="500" y="320" text-anchor="middle" fill="#1e3a8a" font-size="10">totalBilled++, totalCovered++, visitCount++ (Patient.js:1673-1840)</text>
    </svg>
  </div>

  <h3>Convention Coverage Calculation Logic</h3>
  <table>
    <thead>
      <tr>
        <th>Step</th>
        <th>Check</th>
        <th>Action</th>
        <th>Code Reference</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>1</td>
        <td>Category not covered?</td>
        <td>patientShare = 100%, companyShare = 0</td>
        <td><span class="code-ref">invoiceController.js:833-844</span></td>
      </tr>
      <tr>
        <td>2</td>
        <td>Requires approval?</td>
        <td>Check actsRequiringApproval + category.requiresApproval</td>
        <td><span class="code-ref">invoiceController.js:846-874</span></td>
      </tr>
      <tr>
        <td>3</td>
        <td>Auto-approve threshold?</td>
        <td>If price < threshold, skip approval</td>
        <td><span class="code-ref">invoiceController.js:860-874</span></td>
      </tr>
      <tr>
        <td>4</td>
        <td>Valid approval exists?</td>
        <td>Query Approval collection, check validUntil</td>
        <td><span class="code-ref">invoiceController.js:877-889</span></td>
      </tr>
      <tr>
        <td>5</td>
        <td>Apply global discount</td>
        <td>Reduce effective price by discount %</td>
        <td><span class="code-ref">invoiceController.js:903-917</span></td>
      </tr>
      <tr>
        <td>6</td>
        <td>Apply category max (cumulative)</td>
        <td>Track total per category, cap at maxPerCategory</td>
        <td><span class="code-ref">invoiceController.js:928-943</span></td>
      </tr>
    </tbody>
  </table>
</div>

<!-- INVENTORY RESERVATION FLOW -->
<div class="section">
  <h2>5. Inventory Reservation & Dispensing Flow</h2>

  <div class="svg-container">
    <svg viewBox="0 0 900 300" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="900" height="300" fill="#f8fafc"/>

      <!-- Prescription Created -->
      <rect x="50" y="100" width="150" height="70" rx="8" fill="#8b5cf6"/>
      <text x="125" y="130" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Prescription</text>
      <text x="125" y="150" text-anchor="middle" fill="#ede9fe" font-size="10">status: pending</text>

      <!-- Reserve Inventory -->
      <rect x="250" y="100" width="150" height="70" rx="8" fill="#f59e0b"/>
      <text x="325" y="130" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Reserve Stock</text>
      <text x="325" y="150" text-anchor="middle" fill="#fef3c7" font-size="10">reserveInventory()</text>

      <!-- Inventory Update -->
      <rect x="250" y="200" width="150" height="60" rx="6" fill="#fffbeb" stroke="#f59e0b"/>
      <text x="325" y="225" text-anchor="middle" fill="#92400e" font-size="10">PharmacyInventory</text>
      <text x="325" y="245" text-anchor="middle" fill="#92400e" font-size="10">reserved += qty</text>

      <!-- Pharmacy Review -->
      <rect x="450" y="100" width="150" height="70" rx="8" fill="#3b82f6"/>
      <text x="525" y="130" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Pharmacy Review</text>
      <text x="525" y="150" text-anchor="middle" fill="#dbeafe" font-size="10">pharmacyStatus: reviewing</text>

      <!-- Dispense -->
      <rect x="650" y="100" width="150" height="70" rx="8" fill="#10b981"/>
      <text x="725" y="130" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Dispense</text>
      <text x="725" y="150" text-anchor="middle" fill="#d1fae5" font-size="10">status: dispensed</text>

      <!-- Final Inventory -->
      <rect x="650" y="200" width="150" height="60" rx="6" fill="#ecfdf5" stroke="#10b981"/>
      <text x="725" y="225" text-anchor="middle" fill="#065f46" font-size="10">PharmacyInventory</text>
      <text x="725" y="245" text-anchor="middle" fill="#065f46" font-size="10">currentStock -= qty</text>

      <!-- Arrows -->
      <path d="M200,135 L245,135" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
      <path d="M400,135 L445,135" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
      <path d="M600,135 L645,135" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
      <path d="M325,170 L325,195" stroke="#f59e0b" stroke-width="2" stroke-dasharray="4"/>
      <path d="M725,170 L725,195" stroke="#10b981" stroke-width="2" stroke-dasharray="4"/>

      <!-- Cancel path -->
      <path d="M325,95 C325,50 525,50 725,70" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,5" fill="none"/>
      <text x="525" y="45" text-anchor="middle" fill="#ef4444" font-size="10">Cancel → releaseReservation()</text>

      <!-- Labels -->
      <text x="125" y="60" text-anchor="middle" fill="#64748b" font-size="11">Visit.completeVisit()</text>
      <text x="525" y="60" text-anchor="middle" fill="#64748b" font-size="11">Pharmacist workflow</text>
    </svg>
  </div>

  <div class="alert success">
    <strong>Inventory Safety:</strong> Stock is reserved at visit completion, not at dispensing.
    This prevents overselling when multiple pharmacists work concurrently.
    Cancellation releases reserved stock back to available.
    <span class="code-ref">Prescription.js reserveInventory()</span>
  </div>
</div>

<!-- SYSTEM ARCHITECTURE LAYERS -->
<div class="section">
  <h2>6. System Architecture Layers</h2>

  <div class="svg-container">
    <svg viewBox="0 0 1000 450" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="1000" height="450" fill="#f8fafc"/>

      <!-- Frontend Layer -->
      <rect x="50" y="30" width="900" height="80" rx="10" fill="#3b82f6" opacity="0.9"/>
      <text x="500" y="55" text-anchor="middle" fill="white" font-weight="bold" font-size="16">Frontend - React + Redux + Vite</text>
      <text x="150" y="80" text-anchor="middle" fill="#dbeafe" font-size="11">185 Pages</text>
      <text x="300" y="80" text-anchor="middle" fill="#dbeafe" font-size="11">10 Redux Slices</text>
      <text x="450" y="80" text-anchor="middle" fill="#dbeafe" font-size="11">4 Contexts</text>
      <text x="600" y="80" text-anchor="middle" fill="#dbeafe" font-size="11">79 Services</text>
      <text x="750" y="80" text-anchor="middle" fill="#dbeafe" font-size="11">WebSocket Hooks</text>
      <text x="900" y="80" text-anchor="middle" fill="#dbeafe" font-size="11">Offline Support</text>

      <!-- API Layer -->
      <rect x="50" y="130" width="900" height="80" rx="10" fill="#8b5cf6" opacity="0.9"/>
      <text x="500" y="155" text-anchor="middle" fill="white" font-weight="bold" font-size="16">API Layer - Express.js REST + Socket.IO</text>
      <text x="150" y="185" text-anchor="middle" fill="#ede9fe" font-size="11">JWT Auth</text>
      <text x="300" y="185" text-anchor="middle" fill="#ede9fe" font-size="11">Role-Based Access</text>
      <text x="450" y="185" text-anchor="middle" fill="#ede9fe" font-size="11">Multi-Clinic Filter</text>
      <text x="600" y="185" text-anchor="middle" fill="#ede9fe" font-size="11">Audit Logging</text>
      <text x="750" y="185" text-anchor="middle" fill="#ede9fe" font-size="11">Rate Limiting</text>
      <text x="900" y="185" text-anchor="middle" fill="#ede9fe" font-size="11">Validation</text>

      <!-- Business Logic Layer -->
      <rect x="50" y="230" width="900" height="80" rx="10" fill="#f59e0b" opacity="0.9"/>
      <text x="500" y="255" text-anchor="middle" fill="white" font-weight="bold" font-size="16">Business Logic - Controllers + Services</text>
      <text x="150" y="285" text-anchor="middle" fill="#fef3c7" font-size="11">Queue Mgmt</text>
      <text x="300" y="285" text-anchor="middle" fill="#fef3c7" font-size="11">Clinical Workflow</text>
      <text x="450" y="285" text-anchor="middle" fill="#fef3c7" font-size="11">Convention Billing</text>
      <text x="600" y="285" text-anchor="middle" fill="#fef3c7" font-size="11">Inventory Mgmt</text>
      <text x="750" y="285" text-anchor="middle" fill="#fef3c7" font-size="11">Drug Safety</text>
      <text x="900" y="285" text-anchor="middle" fill="#fef3c7" font-size="11">Notifications</text>

      <!-- Data Layer -->
      <rect x="50" y="330" width="900" height="80" rx="10" fill="#10b981" opacity="0.9"/>
      <text x="500" y="355" text-anchor="middle" fill="white" font-weight="bold" font-size="16">Data Layer - MongoDB + Mongoose</text>
      <text x="150" y="385" text-anchor="middle" fill="#d1fae5" font-size="11">84 Models</text>
      <text x="300" y="385" text-anchor="middle" fill="#d1fae5" font-size="11">Transactions</text>
      <text x="450" y="385" text-anchor="middle" fill="#d1fae5" font-size="11">Soft Delete</text>
      <text x="600" y="385" text-anchor="middle" fill="#d1fae5" font-size="11">Optimistic Lock</text>
      <text x="750" y="385" text-anchor="middle" fill="#d1fae5" font-size="11">Indexes</text>
      <text x="900" y="385" text-anchor="middle" fill="#d1fae5" font-size="11">Atomic Counters</text>

      <!-- Connections -->
      <path d="M500,110 L500,125" stroke="#64748b" stroke-width="3"/>
      <path d="M500,210 L500,225" stroke="#64748b" stroke-width="3"/>
      <path d="M500,310 L500,325" stroke="#64748b" stroke-width="3"/>
    </svg>
  </div>
</div>

<!-- KEY BUSINESS LOGIC PATTERNS -->
<div class="section">
  <h2>7. Critical Business Logic Patterns</h2>

  <div class="grid grid-2">
    <div class="card purple">
      <h4>Visit Completion Transaction</h4>
      <p><span class="code-ref">Visit.js:954-1231</span></p>
      <ul>
        <li>Uses MongoDB session for ACID compliance</li>
        <li>Falls back to compensating rollback for standalone</li>
        <li>Creates prescriptions from plan.medications</li>
        <li>Reserves inventory for each prescription</li>
        <li>Generates invoice (excludes medications)</li>
        <li>Updates appointment status to completed</li>
      </ul>
    </div>

    <div class="card orange">
      <h4>State Machine - Valid Transitions</h4>
      <p><span class="code-ref">Visit.js:939-953</span></p>
      <ul>
        <li><strong>scheduled</strong> → checked-in, cancelled, no-show</li>
        <li><strong>checked-in</strong> → in-progress, cancelled</li>
        <li><strong>in-progress</strong> → completed, cancelled</li>
        <li><strong>completed</strong> → (terminal state)</li>
        <li><strong>cancelled</strong> → (terminal state)</li>
      </ul>
    </div>

    <div class="card green">
      <h4>Convention Snapshot (Pricing Lock)</h4>
      <p><span class="code-ref">Visit.js:766-815</span></p>
      <ul>
        <li>Captured at check-in time</li>
        <li>Locks coverage percentage</li>
        <li>Prevents mid-visit coverage changes</li>
        <li>Used by invoice generation</li>
        <li>Includes company name & rules</li>
      </ul>
    </div>

    <div class="card blue">
      <h4>Surgery Case Auto-Creation</h4>
      <p><span class="code-ref">invoiceController.js:15-278</span></p>
      <ul>
        <li>Triggers when surgery item is paid</li>
        <li>Detects surgery by category/keywords</li>
        <li>Creates SurgeryCase with status: awaiting_scheduling</li>
        <li>Links back to invoice item</li>
        <li>Tracks surgeryCaseCreated flag</li>
      </ul>
    </div>

    <div class="card red">
      <h4>Prescription Inventory Reservation</h4>
      <p><span class="code-ref">Prescription.js reserveInventory()</span></p>
      <ul>
        <li>Called at visit completion</li>
        <li>Increments PharmacyInventory.reserved</li>
        <li>Tracks reservedQuantity per medication</li>
        <li>releaseInventoryReservations() on cancel</li>
        <li>Prevents overselling in concurrent scenarios</li>
      </ul>
    </div>

    <div class="card">
      <h4>Queue Priority Sorting</h4>
      <p><span class="code-ref">queueController.js:572-583</span></p>
      <ul>
        <li><strong>Priority Order:</strong></li>
        <li>emergency (0) → urgent (1) → vip (2)</li>
        <li>pregnant (3) → elderly (4) → high (5)</li>
        <li>normal (6)</li>
        <li>Then by queueNumber (FIFO within priority)</li>
      </ul>
    </div>
  </div>
</div>

<!-- WEBSOCKET EVENTS -->
<div class="section">
  <h2>8. Real-Time WebSocket Events</h2>

  <div class="grid grid-3">
    <div class="card blue">
      <h4>Queue Events</h4>
      <ul>
        <li>patient_added</li>
        <li>patient_checked_in</li>
        <li>patient_called</li>
        <li>status_changed</li>
        <li>queue_update</li>
      </ul>
    </div>
    <div class="card green">
      <h4>Billing Events</h4>
      <ul>
        <li>invoice_created</li>
        <li>payment_received</li>
        <li>billing_update</li>
        <li>convention_applied</li>
      </ul>
    </div>
    <div class="card orange">
      <h4>Clinical Events</h4>
      <ul>
        <li>patient_update</li>
        <li>prescription_ready</li>
        <li>lab_results</li>
        <li>visit_update</li>
        <li>critical_alert</li>
      </ul>
    </div>
  </div>

  <p style="margin-top: 20px;"><span class="code-ref">websocketService.js</span> - Handles 20+ event types with room-based subscriptions and message replay for offline users.</p>
</div>

<!-- FILE REFERENCES -->
<div class="section">
  <h2>9. Key File References</h2>

  <h3>Backend (Node.js/Express)</h3>
  <table>
    <thead>
      <tr><th>File</th><th>Purpose</th><th>Lines</th></tr>
    </thead>
    <tbody>
      <tr><td><span class="code-ref">models/Visit.js</span></td><td>Visit model with completeVisit(), generateInvoice()</td><td>~1667</td></tr>
      <tr><td><span class="code-ref">models/Patient.js</span></td><td>Patient with convention, biometric, soft delete</td><td>~2119</td></tr>
      <tr><td><span class="code-ref">models/Invoice.js</span></td><td>Invoice with payments, convention split</td><td>~1200</td></tr>
      <tr><td><span class="code-ref">controllers/invoiceController.js</span></td><td>Convention billing, package deals</td><td>~2068</td></tr>
      <tr><td><span class="code-ref">controllers/queueController.js</span></td><td>Queue management, patient calling</td><td>~1342</td></tr>
      <tr><td><span class="code-ref">services/websocketService.js</span></td><td>Real-time event broadcasting</td><td>~873</td></tr>
    </tbody>
  </table>

  <h3>Frontend (React/Redux)</h3>
  <table>
    <thead>
      <tr><th>File</th><th>Purpose</th><th>Size</th></tr>
    </thead>
    <tbody>
      <tr><td><span class="code-ref">src/App.jsx</span></td><td>Router with 185+ routes</td><td>401 lines</td></tr>
      <tr><td><span class="code-ref">modules/clinical/ClinicalWorkflow.jsx</span></td><td>12-step clinical workflow orchestrator</td><td>~500 lines</td></tr>
      <tr><td><span class="code-ref">pages/PatientDetail/index.jsx</span></td><td>Patient detail with collapsible sections</td><td>37KB</td></tr>
      <tr><td><span class="code-ref">pages/ophthalmology/components/PrescriptionStep.jsx</span></td><td>Prescription entry with safety checks</td><td>65KB</td></tr>
      <tr><td><span class="code-ref">contexts/ClinicContext.jsx</span></td><td>Multi-clinic selection & filtering</td><td>187 lines</td></tr>
      <tr><td><span class="code-ref">hooks/useWebSocket.js</span></td><td>WebSocket hooks for real-time updates</td><td>~200 lines</td></tr>
    </tbody>
  </table>
</div>

<!-- IDENTIFIED PATTERNS -->
<div class="section">
  <h2>10. Architecture Quality Assessment</h2>

  <div class="grid grid-2">
    <div class="card green">
      <h4>Well-Implemented Patterns</h4>
      <ul>
        <li><strong>Convention Snapshot</strong> - Prevents pricing manipulation</li>
        <li><strong>Transaction Support</strong> - ACID with fallback</li>
        <li><strong>Inventory Reservation</strong> - Prevents overselling</li>
        <li><strong>State Machine</strong> - Valid status transitions</li>
        <li><strong>Soft Delete</strong> - Audit trail preservation</li>
        <li><strong>Multi-Clinic Isolation</strong> - X-Clinic-ID header filtering</li>
        <li><strong>WebSocket Events</strong> - Real-time UI updates</li>
        <li><strong>Atomic Counters</strong> - Race-free ID generation</li>
      </ul>
    </div>

    <div class="card orange">
      <h4>Business Logic Correctly Utilized</h4>
      <ul>
        <li><strong>Medication Exclusion</strong> - Visit invoices don't include meds (prevents double-billing)</li>
        <li><strong>Category Max Cumulative</strong> - Tracks total per category across items</li>
        <li><strong>Approval Workflow</strong> - Checks for valid Approval documents</li>
        <li><strong>Package Deals</strong> - Auto-bundles matching acts</li>
        <li><strong>Surgery Auto-Creation</strong> - Creates SurgeryCase on payment</li>
        <li><strong>Queue Priority</strong> - Emergency/VIP patients served first</li>
        <li><strong>Provider Ownership</strong> - Security check on queue updates</li>
        <li><strong>Annual Usage Tracking</strong> - Convention benefit limits</li>
      </ul>
    </div>
  </div>
</div>

</div>

<footer style="text-align: center; padding: 30px; background: #1e293b; color: #94a3b8; margin-top: 40px;">
  <p>Generated: December 2024 | MedFlow EMR System Architecture Documentation</p>
  <p style="font-size: 0.9rem; margin-top: 10px;">Based on comprehensive codebase analysis of 84 models, 185 pages, and complete business logic review</p>
</footer>

</body>
</html>
