<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Functionality Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .online {
            background: #d4edda;
            color: #155724;
        }
        .offline {
            background: #f8d7da;
            color: #721c24;
        }
        .pending {
            background: #fff3cd;
            color: #856404;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>MedFlow Offline Functionality Test</h1>

    <div id="connection-status" class="status">
        Checking connection status...
    </div>

    <div id="service-worker-status" class="status pending">
        Service Worker: Checking...
    </div>

    <div id="indexeddb-status" class="status pending">
        IndexedDB: Checking...
    </div>

    <h2>Test Actions</h2>
    <button onclick="testServiceWorker()">Test Service Worker</button>
    <button onclick="testIndexedDB()">Test IndexedDB</button>
    <button onclick="testOfflineMode()">Simulate Offline</button>
    <button onclick="testOnlineMode()">Simulate Online</button>
    <button onclick="clearCache()">Clear Cache</button>

    <h3>Test Log</h3>
    <div id="log" class="log"></div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        };

        // Check connection status
        const updateConnectionStatus = () => {
            const statusDiv = document.getElementById('connection-status');
            if (navigator.onLine) {
                statusDiv.className = 'status online';
                statusDiv.textContent = '✅ Connection: Online';
            } else {
                statusDiv.className = 'status offline';
                statusDiv.textContent = '❌ Connection: Offline';
            }
        };

        // Monitor connection changes
        window.addEventListener('online', () => {
            updateConnectionStatus();
            log('Connection restored - You are now online');
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus();
            log('Connection lost - You are now offline');
        });

        // Check Service Worker
        const checkServiceWorker = async () => {
            const statusDiv = document.getElementById('service-worker-status');

            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    if (registrations.length > 0) {
                        statusDiv.className = 'status online';
                        statusDiv.textContent = '✅ Service Worker: Registered and Active';
                        log(`Service Worker found: ${registrations[0].scope}`);

                        // Check if SW is controlling the page
                        if (navigator.serviceWorker.controller) {
                            log('Service Worker is controlling this page');
                        } else {
                            log('Service Worker registered but not controlling (first load)');
                        }
                    } else {
                        statusDiv.className = 'status offline';
                        statusDiv.textContent = '⚠️ Service Worker: Not Registered';
                        log('No Service Worker registrations found');
                    }
                } catch (error) {
                    statusDiv.className = 'status offline';
                    statusDiv.textContent = '❌ Service Worker: Error';
                    log(`Service Worker error: ${error.message}`);
                }
            } else {
                statusDiv.className = 'status offline';
                statusDiv.textContent = '❌ Service Worker: Not Supported';
                log('Service Workers are not supported in this browser');
            }
        };

        // Check IndexedDB
        const checkIndexedDB = async () => {
            const statusDiv = document.getElementById('indexeddb-status');

            if ('indexedDB' in window) {
                try {
                    const request = indexedDB.open('MedFlowDB');

                    request.onsuccess = () => {
                        statusDiv.className = 'status online';
                        statusDiv.textContent = '✅ IndexedDB: Available';
                        log('IndexedDB is available and accessible');

                        // List object stores
                        const db = request.result;
                        const storeNames = Array.from(db.objectStoreNames);
                        log(`IndexedDB stores: ${storeNames.join(', ') || 'None yet'}`);
                        db.close();
                    };

                    request.onerror = () => {
                        statusDiv.className = 'status offline';
                        statusDiv.textContent = '❌ IndexedDB: Error';
                        log('Failed to open IndexedDB');
                    };
                } catch (error) {
                    statusDiv.className = 'status offline';
                    statusDiv.textContent = '❌ IndexedDB: Error';
                    log(`IndexedDB error: ${error.message}`);
                }
            } else {
                statusDiv.className = 'status offline';
                statusDiv.textContent = '❌ IndexedDB: Not Supported';
                log('IndexedDB is not supported in this browser');
            }
        };

        // Test functions
        const testServiceWorker = async () => {
            log('Testing Service Worker...');

            if ('serviceWorker' in navigator) {
                try {
                    // Test caching
                    const cache = await caches.open('medflow-v1');
                    const cachedUrls = await cache.keys();
                    log(`Cached URLs: ${cachedUrls.length} files`);

                    // Test message passing
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ type: 'TEST' });
                        log('Sent test message to Service Worker');
                    }
                } catch (error) {
                    log(`Service Worker test error: ${error.message}`, 'error');
                }
            }
        };

        const testIndexedDB = async () => {
            log('Testing IndexedDB...');

            try {
                const request = indexedDB.open('MedFlowDB', 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('test')) {
                        db.createObjectStore('test', { keyPath: 'id' });
                        log('Created test store in IndexedDB');
                    }
                };

                request.onsuccess = () => {
                    const db = request.result;
                    const transaction = db.transaction(['test'], 'readwrite');
                    const store = transaction.objectStore('test');

                    // Add test data
                    const testData = { id: Date.now(), message: 'Test data', timestamp: new Date() };
                    store.add(testData);

                    log('Added test data to IndexedDB');

                    // Read test data
                    const getRequest = store.getAll();
                    getRequest.onsuccess = () => {
                        log(`Retrieved ${getRequest.result.length} test records from IndexedDB`);
                    };

                    db.close();
                };
            } catch (error) {
                log(`IndexedDB test error: ${error.message}`, 'error');
            }
        };

        const testOfflineMode = () => {
            log('Simulating offline mode...');
            window.dispatchEvent(new Event('offline'));
        };

        const testOnlineMode = () => {
            log('Simulating online mode...');
            window.dispatchEvent(new Event('online'));
        };

        const clearCache = async () => {
            log('Clearing cache...');

            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(
                    cacheNames.map(cacheName => {
                        log(`Deleting cache: ${cacheName}`);
                        return caches.delete(cacheName);
                    })
                );
                log('All caches cleared');
            }
        };

        // Initial checks
        updateConnectionStatus();
        checkServiceWorker();
        checkIndexedDB();

        log('Offline functionality test page loaded');
    </script>
</body>
</html>