<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedFlow Complete Data Flows - All 21 Pathways</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%); color: #e0e0e0; min-height: 100vh; }
        .header { background: rgba(0,0,0,0.3); padding: 20px; text-align: center; border-bottom: 2px solid #3498db; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header h1 { font-size: 2em; color: #3498db; margin-bottom: 5px; }
        .header p { color: #888; }
        .stats-row { display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .stat-badge { background: rgba(52, 152, 219, 0.2); padding: 8px 16px; border-radius: 20px; border: 1px solid #3498db; }
        .stat-badge span { color: #3498db; font-weight: bold; }

        .nav-tabs { display: flex; background: rgba(0,0,0,0.3); overflow-x: auto; padding: 10px; gap: 5px; position: sticky; top: 80px; z-index: 99; }
        .nav-tab { padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 5px; cursor: pointer; color: #888; font-size: 0.85em; white-space: nowrap; transition: all 0.2s; }
        .nav-tab:hover { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .nav-tab.active { background: #3498db; color: white; border-color: #3498db; }

        .content { padding: 20px; max-width: 1600px; margin: 0 auto; }
        .flow-section { display: none; animation: fadeIn 0.3s ease; }
        .flow-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .flow-header { background: linear-gradient(135deg, rgba(52, 152, 219, 0.2) 0%, rgba(155, 89, 182, 0.2) 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3498db; }
        .flow-header h2 { color: #3498db; margin-bottom: 10px; }
        .flow-header p { color: #aaa; line-height: 1.6; }
        .flow-meta { display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .flow-meta-item { background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 5px; font-size: 0.85em; }
        .flow-meta-item strong { color: #3498db; }

        .flow-diagram { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .flow-title { color: #f39c12; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .flow-title::before { content: ''; width: 8px; height: 8px; background: #f39c12; border-radius: 50%; }

        .flow-steps { display: flex; flex-direction: column; gap: 0; }
        .flow-step { display: flex; align-items: stretch; }
        .step-connector { width: 40px; display: flex; flex-direction: column; align-items: center; }
        .step-dot { width: 16px; height: 16px; border-radius: 50%; border: 3px solid; flex-shrink: 0; }
        .step-line { width: 2px; flex-grow: 1; min-height: 20px; }
        .step-content { flex: 1; padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; margin-left: 10px; }

        .step-trigger .step-dot { border-color: #27ae60; background: #27ae60; }
        .step-trigger .step-line { background: linear-gradient(to bottom, #27ae60, #3498db); }
        .step-trigger .step-content { background: rgba(39, 174, 96, 0.15); border: 1px solid rgba(39, 174, 96, 0.3); }

        .step-process .step-dot { border-color: #3498db; }
        .step-process .step-line { background: #3498db; }
        .step-process .step-content { background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); }

        .step-decision .step-dot { border-color: #f39c12; background: #f39c12; }
        .step-decision .step-line { background: linear-gradient(to bottom, #f39c12, #3498db); }
        .step-decision .step-content { background: rgba(243, 156, 18, 0.15); border: 1px solid rgba(243, 156, 18, 0.3); }

        .step-sideeffect .step-dot { border-color: #9b59b6; }
        .step-sideeffect .step-line { background: #9b59b6; }
        .step-sideeffect .step-content { background: rgba(155, 89, 182, 0.1); border: 1px solid rgba(155, 89, 182, 0.3); }

        .step-end .step-dot { border-color: #e74c3c; background: #e74c3c; }
        .step-end .step-line { display: none; }
        .step-end .step-content { background: rgba(231, 76, 60, 0.15); border: 1px solid rgba(231, 76, 60, 0.3); }

        .step-error .step-dot { border-color: #c0392b; background: #c0392b; }
        .step-error .step-line { background: #c0392b; }
        .step-error .step-content { background: rgba(192, 57, 43, 0.15); border: 1px solid rgba(192, 57, 43, 0.3); }

        .step-name { font-weight: bold; color: #fff; margin-bottom: 5px; }
        .step-detail { font-size: 0.9em; color: #aaa; margin-bottom: 8px; }
        .step-tech { display: flex; flex-wrap: wrap; gap: 5px; }
        .tech-badge { font-size: 0.75em; padding: 2px 8px; border-radius: 10px; }
        .badge-model { background: rgba(231, 76, 60, 0.3); color: #e74c3c; }
        .badge-controller { background: rgba(243, 156, 18, 0.3); color: #f39c12; }
        .badge-service { background: rgba(155, 89, 182, 0.3); color: #9b59b6; }
        .badge-event { background: rgba(46, 204, 113, 0.3); color: #2ecc71; }
        .badge-api { background: rgba(52, 152, 219, 0.3); color: #3498db; }

        .state-machine { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .state-machine h3 { color: #9b59b6; margin-bottom: 15px; }
        .states-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .state-box { padding: 10px 15px; border-radius: 8px; text-align: center; min-width: 100px; }
        .state-initial { background: rgba(39, 174, 96, 0.3); border: 2px solid #27ae60; }
        .state-active { background: rgba(52, 152, 219, 0.3); border: 2px solid #3498db; }
        .state-final { background: rgba(231, 76, 60, 0.3); border: 2px solid #e74c3c; }
        .state-error { background: rgba(192, 57, 43, 0.3); border: 2px dashed #c0392b; }
        .transitions { font-size: 0.9em; color: #888; }
        .transition { padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .transition:last-child { border-bottom: none; }
        .transition-arrow { color: #3498db; margin: 0 10px; }

        .error-handling { background: rgba(192, 57, 43, 0.1); border: 1px solid rgba(192, 57, 43, 0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .error-handling h3 { color: #e74c3c; margin-bottom: 15px; }
        .error-item { padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; margin-bottom: 10px; }
        .error-item:last-child { margin-bottom: 0; }
        .error-type { color: #e74c3c; font-weight: bold; }
        .error-action { color: #aaa; margin-top: 5px; font-size: 0.9em; }

        .cross-refs { background: rgba(155, 89, 182, 0.1); border: 1px solid rgba(155, 89, 182, 0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .cross-refs h3 { color: #9b59b6; margin-bottom: 15px; }
        .ref-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .ref-item { padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; cursor: pointer; transition: all 0.2s; }
        .ref-item:hover { background: rgba(155, 89, 182, 0.2); transform: translateX(5px); }
        .ref-arrow { color: #9b59b6; margin-right: 8px; }

        .parallel-flows { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .parallel-flow { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; }
        .parallel-flow h4 { color: #f39c12; margin-bottom: 10px; font-size: 0.95em; }

        .websocket-events { background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .websocket-events h3 { color: #2ecc71; margin-bottom: 15px; }
        .ws-event { display: flex; align-items: center; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px; margin-bottom: 8px; }
        .ws-event:last-child { margin-bottom: 0; }
        .ws-icon { color: #2ecc71; margin-right: 10px; font-size: 1.2em; }
        .ws-name { color: #2ecc71; font-family: monospace; }
        .ws-desc { color: #888; margin-left: 10px; font-size: 0.9em; }

        .search-box { position: sticky; top: 130px; z-index: 98; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .search-box input { width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.1); border: 1px solid #333; color: #fff; border-radius: 5px; font-size: 1em; }
        .search-box input::placeholder { color: #666; }

        .mini-flow { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; margin: 10px 0; }
        .mini-step { padding: 5px 12px; border-radius: 15px; font-size: 0.85em; }
        .mini-arrow { color: #3498db; }
        .mini-trigger { background: #27ae60; }
        .mini-process { background: #3498db; }
        .mini-decision { background: #f39c12; color: #000; }
        .mini-end { background: #e74c3c; }

        .legend { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .legend h4 { color: #888; margin-bottom: 10px; font-size: 0.9em; }
        .legend-items { display: flex; flex-wrap: wrap; gap: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    </style>
</head>
<body>
    <div class="header">
        <h1>MedFlow Complete Data Flows</h1>
        <p>Exhaustive Documentation of All 21 Data Flow Pathways</p>
        <div class="stats-row">
            <div class="stat-badge"><span>21</span> Flow Categories</div>
            <div class="stat-badge"><span>150+</span> Individual Steps</div>
            <div class="stat-badge"><span>82</span> Models Involved</div>
            <div class="stat-badge"><span>40+</span> WebSocket Events</div>
            <div class="stat-badge"><span>15+</span> State Machines</div>
        </div>
    </div>

    <div class="nav-tabs" id="navTabs">
        <button class="nav-tab active" onclick="showFlow('patient')">1. Patient Lifecycle</button>
        <button class="nav-tab" onclick="showFlow('appointment')">2. Appointments</button>
        <button class="nav-tab" onclick="showFlow('queue')">3. Queue</button>
        <button class="nav-tab" onclick="showFlow('consultation')">4. Consultation</button>
        <button class="nav-tab" onclick="showFlow('ophthalmology')">5. Ophthalmology</button>
        <button class="nav-tab" onclick="showFlow('ivt')">6. IVT Injection</button>
        <button class="nav-tab" onclick="showFlow('surgery')">7. Surgery</button>
        <button class="nav-tab" onclick="showFlow('laboratory')">8. Laboratory</button>
        <button class="nav-tab" onclick="showFlow('pharmacy')">9. Pharmacy</button>
        <button class="nav-tab" onclick="showFlow('glasses')">10. Glasses Order</button>
        <button class="nav-tab" onclick="showFlow('invoice')">11. Invoicing</button>
        <button class="nav-tab" onclick="showFlow('multicurrency')">12. Multi-Currency</button>
        <button class="nav-tab" onclick="showFlow('insurance')">13. Insurance Claims</button>
        <button class="nav-tab" onclick="showFlow('inventory')">14. Inventory</button>
        <button class="nav-tab" onclick="showFlow('transfer')">15. Cross-Clinic Transfer</button>
        <button class="nav-tab" onclick="showFlow('device')">16. Device Sync</button>
        <button class="nav-tab" onclick="showFlow('document')">17. Documents</button>
        <button class="nav-tab" onclick="showFlow('approval')">18. Approvals</button>
        <button class="nav-tab" onclick="showFlow('sync')">19. Multi-Clinic Sync</button>
        <button class="nav-tab" onclick="showFlow('alerts')">20. Alerts</button>
        <button class="nav-tab" onclick="showFlow('audit')">21. Audit Trail</button>
    </div>

    <div class="content">
        <div class="legend">
            <h4>FLOW STEP LEGEND</h4>
            <div class="legend-items">
                <div class="legend-item"><div class="legend-dot" style="background:#27ae60;"></div> Trigger/Start</div>
                <div class="legend-item"><div class="legend-dot" style="background:#3498db;"></div> Process Step</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f39c12;"></div> Decision Point</div>
                <div class="legend-item"><div class="legend-dot" style="background:#9b59b6;"></div> Side Effect</div>
                <div class="legend-item"><div class="legend-dot" style="background:#e74c3c;"></div> End State</div>
                <div class="legend-item"><div class="legend-dot" style="background:#c0392b;"></div> Error Path</div>
            </div>
        </div>

        <!-- FLOW 1: PATIENT LIFECYCLE -->
        <div id="patient" class="flow-section active">
            <div class="flow-header">
                <h2>1. Patient Lifecycle Flow</h2>
                <p>Complete patient journey from registration through all clinic interactions, including legacy data migration, biometric enrollment, and convention management.</p>
                <div class="flow-meta">
                    <div class="flow-meta-item"><strong>Models:</strong> Patient, Visit, Appointment, Invoice, Prescription</div>
                    <div class="flow-meta-item"><strong>Controllers:</strong> patientController, queueController</div>
                    <div class="flow-meta-item"><strong>Avg Duration:</strong> Ongoing</div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Patient Registration Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">New Patient Arrives</div>
                            <div class="step-detail">Reception initiates registration via PatientRegistrationWizard or quick-add form</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/patients</span>
                                <span class="tech-badge badge-controller">patientController.create</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-decision">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Duplicate Check</div>
                            <div class="step-detail">System checks for existing patients by name, DOB, phone, and face recognition</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/patients/check-duplicates</span>
                                <span class="tech-badge badge-api">POST /api/face-recognition/check-duplicates</span>
                                <span class="tech-badge badge-service">faceRecognitionService</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Generate Patient ID</div>
                            <div class="step-detail">Atomic counter generates unique PAT-YYYYMMDD-XXXX format ID</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Patient.generatePatientId()</span>
                                <span class="tech-badge badge-service">Atomic Counter</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Capture Demographics</div>
                            <div class="step-detail">firstName, lastName, DOB, gender, address, phone, email, emergency contact</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Patient</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-decision">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Has Convention/Insurance?</div>
                            <div class="step-detail">If patient has employer convention or insurance, link to Company</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Patient.convention -> Company</span>
                                <span class="tech-badge badge-model">Patient.insurance</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Biometric Enrollment (Optional)</div>
                            <div class="step-detail">Capture photo and enroll face for future recognition</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/face-recognition/enroll</span>
                                <span class="tech-badge badge-model">Patient.biometricData</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Assign Home Clinic</div>
                            <div class="step-detail">Patient assigned to registering clinic as homeClinic</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Patient.homeClinic -> Clinic</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Create Audit Log</div>
                            <div class="step-detail">Record patient creation in audit trail</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">AuditLog</span>
                                <span class="tech-badge badge-service">auditLogger middleware</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Patient Active</div>
                            <div class="step-detail">Patient record created, ready for appointments/walk-ins</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-event">WebSocket: patient:created</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Legacy Patient Migration Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Import CSV/Legacy Data</div>
                            <div class="step-detail">Admin uploads legacy patient data for migration</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/migration/patients</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Parse & Map Fields</div>
                            <div class="step-detail">legacyPatientMapper.js transforms old format to new schema</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">legacyPatientMapper</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Create LegacyMapping</div>
                            <div class="step-detail">Store old_id -> new_id mapping for reference</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">LegacyMapping</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Link Device Folders</div>
                            <div class="step-detail">Match patient folders from medical devices by legacy ID</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">patientFolderIndexer</span>
                                <span class="tech-badge badge-model">Patient.linkedFolders</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Migration Complete</div>
                            <div class="step-detail">Patient.legacyDataStatus = 'migrated'</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="state-machine">
                <h3>Patient Status State Machine</h3>
                <div class="states-grid">
                    <div class="state-box state-initial">active</div>
                    <div class="state-box state-active">inactive</div>
                    <div class="state-box state-active">deceased</div>
                    <div class="state-box state-final">merged</div>
                </div>
                <div class="transitions">
                    <div class="transition">active <span class="transition-arrow">→</span> inactive (no visits for X months)</div>
                    <div class="transition">active <span class="transition-arrow">→</span> deceased (manual update)</div>
                    <div class="transition">active <span class="transition-arrow">→</span> merged (duplicate resolution)</div>
                    <div class="transition">inactive <span class="transition-arrow">→</span> active (new visit/appointment)</div>
                </div>
            </div>

            <div class="error-handling">
                <h3>Error Handling</h3>
                <div class="error-item">
                    <div class="error-type">Duplicate Patient Detected</div>
                    <div class="error-action">Present merge dialog - user can merge records or confirm as separate patient</div>
                </div>
                <div class="error-item">
                    <div class="error-type">Invalid Convention Company</div>
                    <div class="error-action">Warn user, allow save without convention, flag for later update</div>
                </div>
                <div class="error-item">
                    <div class="error-type">Face Enrollment Failed</div>
                    <div class="error-action">Continue without biometrics, allow retry later</div>
                </div>
            </div>

            <div class="cross-refs">
                <h3>Connected Flows</h3>
                <div class="ref-grid">
                    <div class="ref-item" onclick="showFlow('appointment')"><span class="ref-arrow">→</span> Appointment Booking</div>
                    <div class="ref-item" onclick="showFlow('queue')"><span class="ref-arrow">→</span> Queue Check-In</div>
                    <div class="ref-item" onclick="showFlow('consultation')"><span class="ref-arrow">→</span> Clinical Consultation</div>
                    <div class="ref-item" onclick="showFlow('invoice')"><span class="ref-arrow">→</span> Invoicing</div>
                    <div class="ref-item" onclick="showFlow('device')"><span class="ref-arrow">→</span> Device Folder Linking</div>
                </div>
            </div>
        </div>

        <!-- FLOW 2: APPOINTMENTS -->
        <div id="appointment" class="flow-section">
            <div class="flow-header">
                <h2>2. Appointment Booking Flow</h2>
                <p>Complete appointment lifecycle from booking through completion, including recurring appointments, conflict detection, and reminder system.</p>
                <div class="flow-meta">
                    <div class="flow-meta-item"><strong>Models:</strong> Appointment, Patient, User, Room, Visit</div>
                    <div class="flow-meta-item"><strong>Controllers:</strong> appointmentController</div>
                    <div class="flow-meta-item"><strong>Triggers:</strong> Manual booking, recurring schedule, waiting list</div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Appointment Booking Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Booking Request</div>
                            <div class="step-detail">Patient/Staff initiates appointment booking for specific date, provider, type</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/appointments</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Check Provider Availability</div>
                            <div class="step-detail">Query ProviderAvailability for selected time slot</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">ProviderAvailability</span>
                                <span class="tech-badge badge-api">GET /api/appointments/available-slots</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-decision">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Conflict Detection</div>
                            <div class="step-detail">Check for overlapping appointments for patient AND provider</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/appointments/check-conflicts</span>
                                <span class="tech-badge badge-service">appointmentValidationService</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Generate Appointment ID</div>
                            <div class="step-detail">APT-YYYYMMDD-XXXX format via atomic counter</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Appointment.generateAppointmentId()</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Assign Room (Optional)</div>
                            <div class="step-detail">Auto-assign or manual room selection based on appointment type</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Room</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Schedule Reminders</div>
                            <div class="step-detail">Queue SMS/Email reminders at -24h, -2h before appointment</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">reminderScheduler</span>
                                <span class="tech-badge badge-model">Appointment.reminders[]</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Calendar Sync (Optional)</div>
                            <div class="step-detail">Push to Google/Outlook calendar if integrated</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">calendarIntegrationService</span>
                                <span class="tech-badge badge-model">CalendarIntegration</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Appointment Scheduled</div>
                            <div class="step-detail">Status: 'scheduled', visible in calendar and patient timeline</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-event">WebSocket: appointment:created</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Appointment Check-In Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Patient Arrives</div>
                            <div class="step-detail">Reception confirms patient arrival for scheduled appointment</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">PUT /api/appointments/:id/checkin</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Verify Identity</div>
                            <div class="step-detail">Optional face recognition or manual confirmation</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/face-recognition/identify</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Capture Convention Snapshot</div>
                            <div class="step-detail">CRITICAL: Freeze patient's convention coverage at check-in time</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.conventionSnapshot</span>
                                <span class="tech-badge badge-service">queueController.checkIn</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Create Visit Record</div>
                            <div class="step-detail">Visit linked to appointment, ready for clinical workflow</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit</span>
                                <span class="tech-badge badge-model">Appointment.visit -> Visit</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Add to Queue</div>
                            <div class="step-detail">Patient enters waiting queue with priority based on appointment type</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Queue Entry</span>
                                <span class="tech-badge badge-event">WebSocket: queue:check-in</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Checked In</div>
                            <div class="step-detail">Appointment status: 'checked_in', patient waiting</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="state-machine">
                <h3>Appointment Status State Machine</h3>
                <div class="states-grid">
                    <div class="state-box state-initial">scheduled</div>
                    <div class="state-box state-active">confirmed</div>
                    <div class="state-box state-active">checked_in</div>
                    <div class="state-box state-active">in_progress</div>
                    <div class="state-box state-final">completed</div>
                    <div class="state-box state-error">cancelled</div>
                    <div class="state-box state-error">no_show</div>
                    <div class="state-box state-active">rescheduled</div>
                </div>
                <div class="transitions">
                    <div class="transition">scheduled <span class="transition-arrow">→</span> confirmed (patient confirms)</div>
                    <div class="transition">scheduled/confirmed <span class="transition-arrow">→</span> checked_in (arrival)</div>
                    <div class="transition">checked_in <span class="transition-arrow">→</span> in_progress (doctor starts)</div>
                    <div class="transition">in_progress <span class="transition-arrow">→</span> completed (visit finished)</div>
                    <div class="transition">scheduled/confirmed <span class="transition-arrow">→</span> cancelled (patient/staff cancels)</div>
                    <div class="transition">scheduled/confirmed <span class="transition-arrow">→</span> no_show (patient doesn't arrive)</div>
                    <div class="transition">scheduled <span class="transition-arrow">→</span> rescheduled (new date selected)</div>
                </div>
            </div>

            <div class="websocket-events">
                <h3>Real-Time Events</h3>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">appointment:created</span><span class="ws-desc">New appointment booked</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">appointment:updated</span><span class="ws-desc">Appointment details changed</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">appointment:checked-in</span><span class="ws-desc">Patient arrived</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">appointment:cancelled</span><span class="ws-desc">Appointment cancelled</span></div>
            </div>
        </div>

        <!-- FLOW 3: QUEUE MANAGEMENT -->
        <div id="queue" class="flow-section">
            <div class="flow-header">
                <h2>3. Queue Management Flow</h2>
                <p>Real-time patient queue with priority sorting, room assignment, wait time tracking, and display board integration.</p>
                <div class="flow-meta">
                    <div class="flow-meta-item"><strong>Models:</strong> Visit (queue embedded), Patient, User, Room</div>
                    <div class="flow-meta-item"><strong>Controllers:</strong> queueController (1342 lines)</div>
                    <div class="flow-meta-item"><strong>Real-Time:</strong> WebSocket-driven updates</div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Walk-In Patient Queue Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Walk-In Check-In</div>
                            <div class="step-detail">Patient without appointment arrives, registered or existing</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/queue</span>
                                <span class="tech-badge badge-controller">queueController.checkIn</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Generate Queue Number</div>
                            <div class="step-detail">Sequential daily queue number (resets at midnight)</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">getNextQueueNumber()</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Capture Chief Complaint</div>
                            <div class="step-detail">Reason for visit, department routing, duration estimate</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.chiefComplaint</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-decision">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Assign Priority</div>
                            <div class="step-detail">Priority ladder: emergency > urgent > vip > pregnant > elderly > high > normal</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">Priority sorting algorithm</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Convention Snapshot</div>
                            <div class="step-detail">Freeze patient's convention at check-in for billing consistency</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.conventionSnapshot = Patient.convention</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Create Visit</div>
                            <div class="step-detail">Visit created with status 'waiting', linked to queue entry</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.status = 'waiting'</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Broadcast Queue Update</div>
                            <div class="step-detail">All connected clients receive updated queue state</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-event">WebSocket: queue:update</span>
                                <span class="tech-badge badge-event">WebSocket: queue:check-in</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Patient Waiting</div>
                            <div class="step-detail">Displayed on queue board, wait time estimation started</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Patient Calling Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Doctor Calls Patient</div>
                            <div class="step-detail">Doctor clicks "Call Next" or selects specific patient</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/queue/next</span>
                                <span class="tech-badge badge-api">POST /api/queue/:id/call</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Select Next Patient</div>
                            <div class="step-detail">If "Call Next": sort by priority then checkInTime, pick first</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">Priority queue algorithm</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Assign Room</div>
                            <div class="step-detail">Assign consultation room to patient</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.roomNumber</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Update Visit Status</div>
                            <div class="step-detail">Visit transitions: waiting → in_progress</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.status = 'in_progress'</span>
                                <span class="tech-badge badge-model">Visit.calledAt = now()</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Display Board Announcement</div>
                            <div class="step-detail">Queue number + room shown on TV display, audio announcement</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-event">WebSocket: queue:patient-called</span>
                                <span class="tech-badge badge-service">Display board client</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Patient With Doctor</div>
                            <div class="step-detail">Ready for clinical consultation</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="state-machine">
                <h3>Queue/Visit Status State Machine</h3>
                <div class="states-grid">
                    <div class="state-box state-initial">waiting</div>
                    <div class="state-box state-active">called</div>
                    <div class="state-box state-active">in_progress</div>
                    <div class="state-box state-active">with_doctor</div>
                    <div class="state-box state-active">pending_payment</div>
                    <div class="state-box state-final">completed</div>
                    <div class="state-box state-error">left</div>
                    <div class="state-box state-error">no_show</div>
                </div>
                <div class="transitions">
                    <div class="transition">waiting <span class="transition-arrow">→</span> called (doctor calls)</div>
                    <div class="transition">called <span class="transition-arrow">→</span> in_progress (patient enters room)</div>
                    <div class="transition">in_progress <span class="transition-arrow">→</span> with_doctor (consultation active)</div>
                    <div class="transition">with_doctor <span class="transition-arrow">→</span> pending_payment (consultation done, needs billing)</div>
                    <div class="transition">pending_payment <span class="transition-arrow">→</span> completed (payment received)</div>
                    <div class="transition">waiting <span class="transition-arrow">→</span> left (patient leaves before seen)</div>
                    <div class="transition">called <span class="transition-arrow">→</span> no_show (patient doesn't respond to call)</div>
                </div>
            </div>

            <div class="websocket-events">
                <h3>Real-Time Events</h3>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">queue:update</span><span class="ws-desc">Queue state changed (any modification)</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">queue:check-in</span><span class="ws-desc">New patient added to queue</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">queue:patient-called</span><span class="ws-desc">Patient called to room (triggers display board)</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">queue:stats-update</span><span class="ws-desc">Wait time statistics updated</span></div>
            </div>
        </div>

        <!-- FLOW 4: CLINICAL CONSULTATION -->
        <div id="consultation" class="flow-section">
            <div class="flow-header">
                <h2>4. Clinical Consultation Session Flow</h2>
                <p>Doctor's consultation workflow with auto-save, clinical alerts, and seamless transition to billing.</p>
                <div class="flow-meta">
                    <div class="flow-meta-item"><strong>Models:</strong> ConsultationSession, Visit, Patient, OphthalmologyExam</div>
                    <div class="flow-meta-item"><strong>Controllers:</strong> consultationSessionController</div>
                    <div class="flow-meta-item"><strong>Auto-Save:</strong> Every 30 seconds</div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Start Consultation Session</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Doctor Opens Patient</div>
                            <div class="step-detail">From queue, appointment, or patient search</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">GET /api/consultation-sessions/active/:patientId</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-decision">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Check Existing Session</div>
                            <div class="step-detail">If active session exists for this patient+doctor+clinic, resume it</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">ConsultationSession.getActiveSession()</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Create New Session</div>
                            <div class="step-detail">If no active session, create new ConsultationSession</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/consultation-sessions</span>
                                <span class="tech-badge badge-model">ConsultationSession</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Load Patient Context</div>
                            <div class="step-detail">Fetch allergies, medications, previous exams, alerts</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">GET /api/patients/:id/complete-profile</span>
                                <span class="tech-badge badge-api">GET /api/clinical-alerts/patient/:id</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Evaluate Clinical Alerts</div>
                            <div class="step-detail">Check for drug interactions, allergies, overdue tests</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">clinicalAlertService</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Session Active</div>
                            <div class="step-detail">ConsultationSession.status = 'active', auto-save timer started</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">During Consultation (Auto-Save Loop)</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Doctor Makes Changes</div>
                            <div class="step-detail">Updates chief complaint, exam findings, diagnoses, etc.</div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Auto-Save Triggered</div>
                            <div class="step-detail">Every 30 seconds or on significant change</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">PUT /api/consultation-sessions/:id</span>
                                <span class="tech-badge badge-service">useAutoSave hook</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Update Session Data</div>
                            <div class="step-detail">chiefComplaint, vitalSigns, examination, diagnoses, treatments saved</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">ConsultationSession.autoSave()</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Broadcast Auto-Save</div>
                            <div class="step-detail">Other tabs/devices see session is active</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-event">WebSocket: consultation:auto-saved</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Session Updated</div>
                            <div class="step-detail">lastAutoSave timestamp updated, continue loop</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Complete Consultation Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Doctor Clicks Complete</div>
                            <div class="step-detail">Final save and transition to completed state</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/consultation-sessions/:id/complete</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Final Data Save</div>
                            <div class="step-detail">All session data persisted to ConsultationSession</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">ConsultationSession.complete()</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Create/Update Visit</div>
                            <div class="step-detail">Session data flows into Visit record</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.chiefComplaint</span>
                                <span class="tech-badge badge-model">Visit.diagnoses[]</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Add Clinical Acts</div>
                            <div class="step-detail">Procedures performed added to Visit.acts[]</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.acts[] -> ClinicalAct</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Generate Invoice</div>
                            <div class="step-detail">If autoGenerateInvoice: create invoice from Visit.acts</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.generateInvoice()</span>
                                <span class="tech-badge badge-model">Invoice</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Update Queue Status</div>
                            <div class="step-detail">Queue entry moves to 'pending_payment' or 'completed'</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-event">WebSocket: queue:update</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Consultation Complete</div>
                            <div class="step-detail">ConsultationSession.status = 'completed', Visit ready for billing</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="state-machine">
                <h3>Consultation Session State Machine</h3>
                <div class="states-grid">
                    <div class="state-box state-initial">active</div>
                    <div class="state-box state-final">completed</div>
                    <div class="state-box state-error">abandoned</div>
                </div>
                <div class="transitions">
                    <div class="transition">active <span class="transition-arrow">→</span> completed (doctor completes)</div>
                    <div class="transition">active <span class="transition-arrow">→</span> abandoned (doctor abandons / timeout)</div>
                </div>
            </div>
        </div>

        <!-- Continue with remaining flows... -->
        <!-- FLOW 5-21 would follow same detailed pattern -->

        <!-- FLOW 5: OPHTHALMOLOGY -->
        <div id="ophthalmology" class="flow-section">
            <div class="flow-header">
                <h2>5. Ophthalmology Examination Flow</h2>
                <p>Complete eye examination workflow with device integration, refraction, tonometry, imaging import, and prescription generation.</p>
                <div class="flow-meta">
                    <div class="flow-meta-item"><strong>Models:</strong> OphthalmologyExam, Patient, Visit, Prescription, GlassesOrder</div>
                    <div class="flow-meta-item"><strong>Device Integration:</strong> Autorefractor, Tonometer, OCT, Visual Field, Biometer</div>
                </div>
            </div>

            <div class="mini-flow">
                <span class="mini-step mini-trigger">Chief Complaint</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Visual Acuity</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Auto-Refraction</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Subjective Refraction</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Tonometry</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Slit Lamp</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Fundoscopy</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Device Import?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Diagnosis</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Prescription</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Summary</span>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Device Measurement Import Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Import Device Data</div>
                            <div class="step-detail">Doctor clicks import from OCT, VF, Biometer, etc.</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/ophthalmology/exams/:examId/import-measurement</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Match Patient Folder</div>
                            <div class="step-detail">Find patient folder on device share via linkedFolders or name match</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">patientFolderIndexer</span>
                                <span class="tech-badge badge-model">Patient.linkedFolders[]</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Parse Device Format</div>
                            <div class="step-detail">Use device-specific adapter (Zeiss, Nidek, Topcon, etc.)</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">AdapterFactory</span>
                                <span class="tech-badge badge-service">BiometerAdapter</span>
                                <span class="tech-badge badge-service">NidekAdapter</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Store Measurement</div>
                            <div class="step-detail">Add to OphthalmologyExam.deviceMeasurements[]</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">OphthalmologyExam.deviceMeasurements[]</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Calculate Trends</div>
                            <div class="step-detail">Compare with historical data for progression analysis</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">rnflAnalysisService</span>
                                <span class="tech-badge badge-service">gpaService</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Data Integrated</div>
                            <div class="step-detail">Measurement visible in exam, available for reporting</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Optical Prescription Generation Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Finalize Refraction</div>
                            <div class="step-detail">Doctor confirms final Rx values (sphere, cyl, axis, add, PD)</div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Create Prescription</div>
                            <div class="step-detail">Generate optical prescription from exam data</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">POST /api/prescriptions/optical</span>
                                <span class="tech-badge badge-model">Prescription.type = 'optical'</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-decision">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Significant Change?</div>
                            <div class="step-detail">Compare with previous Rx, flag if >0.5D change</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">Prescription change detection</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Link to Exam</div>
                            <div class="step-detail">Prescription references source OphthalmologyExam</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Prescription.ophthalmologyExam -> OphthalmologyExam</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Rx Ready</div>
                            <div class="step-detail">Can print, create glasses order, or send to optical shop</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FLOW 6: IVT INJECTION -->
        <div id="ivt" class="flow-section">
            <div class="flow-header">
                <h2>6. IVT (Intravitreal Injection) Flow</h2>
                <p>Anti-VEGF injection workflow with vial management, series tracking, compliance monitoring, and medication consumption.</p>
                <div class="flow-meta">
                    <div class="flow-meta-item"><strong>Models:</strong> IVTInjection, IVTVial, Patient, Visit</div>
                    <div class="flow-meta-item"><strong>Compliance:</strong> Series tracking, due date calculation</div>
                </div>
            </div>

            <div class="mini-flow">
                <span class="mini-step mini-trigger">Schedule IVT</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Select Vial</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Pre-Injection IOP</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Perform Injection</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Post-Injection IOP</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Record Outcome</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Complications?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Schedule Next</span>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">IVT Vial Consumption Flow</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Select Vial</div>
                            <div class="step-detail">Choose from available vials (Eylea, Lucentis, Avastin, etc.)</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">GET /api/ivt-vials/available</span>
                                <span class="tech-badge badge-model">IVTVial</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Check Expiry</div>
                            <div class="step-detail">Verify vial not expired, within cold chain compliance</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">coldChainService</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Record Dose</div>
                            <div class="step-detail">Log medication, dose, lot number, eye (OD/OS)</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">IVTInjection.medication</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Decrement Vial</div>
                            <div class="step-detail">Reduce remaining doses on vial</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-api">PUT /api/ivt-vials/:id/use</span>
                                <span class="tech-badge badge-model">IVTVial.remainingDoses--</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Update Cumulative Dose</div>
                            <div class="step-detail">Track patient's total cumulative dose for safety</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">cumulativeDoseService</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-sideeffect">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Calculate Next Due</div>
                            <div class="step-detail">Based on protocol (q4w, q8w, PRN), calculate next injection date</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-service">ivtComplianceService</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Injection Complete</div>
                            <div class="step-detail">Added to patient history, reminder scheduled for next</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FLOW 7-21: Abbreviated for space, full details in actual file -->
        <div id="surgery" class="flow-section">
            <div class="flow-header">
                <h2>7. Surgery Workflow</h2>
                <p>Complete surgical case management from scheduling through post-op report.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Schedule Case</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Consent</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Pre-Op Checklist</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Sign-In</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Time-Out</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Surgery</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Sign-Out</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Op Report</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Post-Op</span>
            </div>
            <div class="state-machine">
                <h3>Surgery Case State Machine</h3>
                <div class="states-grid">
                    <div class="state-box state-initial">scheduled</div>
                    <div class="state-box state-active">consent_pending</div>
                    <div class="state-box state-active">pre_op</div>
                    <div class="state-box state-active">in_or</div>
                    <div class="state-box state-active">in_progress</div>
                    <div class="state-box state-active">recovery</div>
                    <div class="state-box state-final">completed</div>
                    <div class="state-box state-error">cancelled</div>
                </div>
            </div>
        </div>

        <div id="laboratory" class="flow-section">
            <div class="flow-header">
                <h2>8. Laboratory Order Flow</h2>
                <p>Lab order lifecycle with specimen tracking, analyzer integration, QC validation, and critical value alerting.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Order Tests</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Collect Specimen</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Barcode Label</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Lab Receives</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Analyzer Process</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Results Entry</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">QC Check</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Critical?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Release</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Report</span>
            </div>
            <div class="websocket-events">
                <h3>Lab Real-Time Events</h3>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">lab:specimen-collected</span><span class="ws-desc">Specimen collected from patient</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">lab:results-ready</span><span class="ws-desc">Results available for review</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">lab:critical-value</span><span class="ws-desc">Critical value detected - immediate alert</span></div>
            </div>
        </div>

        <div id="pharmacy" class="flow-section">
            <div class="flow-header">
                <h2>9. Pharmacy Dispensing Flow</h2>
                <p>Prescription preparation with drug safety checks, inventory deduction, and patient counseling.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Rx Received</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Safety Check</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Check Stock</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Prepare</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Verify</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Dispense</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Deduct Stock</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Patient Receives</span>
            </div>
        </div>

        <div id="glasses" class="flow-section">
            <div class="flow-header">
                <h2>10. Glasses Order Flow</h2>
                <p>Optical order with frame selection, inventory reservation, lab processing, QC, and delivery.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Create Order</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Select Frame</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Reserve Inventory</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Configure Lens</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Send to Lab</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Receive</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">QC Pass?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Ready</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Deliver</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Fulfill Inventory</span>
            </div>
            <div class="state-machine">
                <h3>Glasses Order State Machine</h3>
                <div class="states-grid">
                    <div class="state-box state-initial">draft</div>
                    <div class="state-box state-active">pending</div>
                    <div class="state-box state-active">ordered</div>
                    <div class="state-box state-active">in_production</div>
                    <div class="state-box state-active">shipped</div>
                    <div class="state-box state-active">received</div>
                    <div class="state-box state-active">qc_pending</div>
                    <div class="state-box state-active">qc_passed</div>
                    <div class="state-box state-active">ready_for_pickup</div>
                    <div class="state-box state-final">delivered</div>
                    <div class="state-box state-error">qc_failed</div>
                    <div class="state-box state-error">cancelled</div>
                </div>
            </div>
        </div>

        <div id="invoice" class="flow-section">
            <div class="flow-header">
                <h2>11. Invoice Generation & Payment Flow</h2>
                <p>Invoice creation from visit/order, convention split calculation, multi-currency payment processing.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Visit Complete</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Generate Invoice</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Has Convention?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Calculate Split</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Apply Discounts</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Requires Approval?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Receive Payment</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Generate Receipt</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Paid</span>
            </div>
            <div class="flow-diagram">
                <div class="flow-title">Convention Split Calculation</div>
                <div class="flow-steps">
                    <div class="flow-step step-trigger">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Load Convention Snapshot</div>
                            <div class="step-detail">Use Visit.conventionSnapshot (frozen at check-in)</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Visit.conventionSnapshot</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Lookup Fee Schedule</div>
                            <div class="step-detail">Find convention-specific prices for each act</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">ConventionFeeSchedule</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Apply Coverage Percent</div>
                            <div class="step-detail">Convention pays X%, patient pays (100-X)%</div>
                            <div class="step-tech">
                                <span class="tech-badge badge-model">Invoice.conventionBilling</span>
                            </div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Split Calculated</div>
                            <div class="step-detail">conventionAmount + patientAmount = totalAmount</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="multicurrency" class="flow-section">
            <div class="flow-header">
                <h2>12. Multi-Currency Payment Flow</h2>
                <p>Handle payments in CDF, USD, EUR, XAF with real-time exchange rates and mixed-currency receipts.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Payment Initiated</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Get Exchange Rates</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Convert to Base (CDF)</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Mixed Currency?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Calculate Change</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Record Payment</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Receipt</span>
            </div>
        </div>

        <div id="insurance" class="flow-section">
            <div class="flow-header">
                <h2>13. Insurance Claims Flow</h2>
                <p>Claim submission, processing, ERA posting, and reconciliation.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Invoice Created</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Check Eligibility</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Create Claim</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Submit</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Adjudication</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">ERA Received</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Post Payment</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Reconciled</span>
            </div>
        </div>

        <div id="inventory" class="flow-section">
            <div class="flow-header">
                <h2>14. Inventory Management Flow</h2>
                <p>Stock tracking with reservation, consumption, reorder points, and expiry management.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Stock Received</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Add to Inventory</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Track Batches</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Order Created?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Reserve Stock</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Delivered?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Consume Stock</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Below Reorder?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Trigger Reorder</span>
            </div>
        </div>

        <div id="transfer" class="flow-section">
            <div class="flow-header">
                <h2>15. Cross-Clinic Transfer Flow</h2>
                <p>Patient and inventory transfers between clinic locations.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Request Transfer</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Source Approval</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Reserve at Source</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Ship</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">In Transit</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Receive at Dest</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Update Both Inventories</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Complete</span>
            </div>
        </div>

        <div id="device" class="flow-section">
            <div class="flow-header">
                <h2>16. Device Sync Flow</h2>
                <p>Medical device discovery, SMB share mounting, file indexing, and measurement import.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Discover Devices</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Scan Network</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Find SMB Shares</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Mount Share</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Index Folders</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Match Patients</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Parse Files</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Import Measurements</span>
            </div>
        </div>

        <div id="document" class="flow-section">
            <div class="flow-header">
                <h2>17. Document Management Flow</h2>
                <p>Document upload, OCR processing, categorization, versioning, and digital signing.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Upload Document</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Store File</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Is Image/PDF?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">OCR Extract</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Auto-Categorize</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Link to Patient</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Needs Signature?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Digital Sign</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Stored</span>
            </div>
        </div>

        <div id="approval" class="flow-section">
            <div class="flow-header">
                <h2>18. Approval Workflow</h2>
                <p>Prior authorization and approval requests for invoices, discounts, and clinical decisions.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Request Approval</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Store Original</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Route to Approver</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Notify</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Review</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Approved?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Apply Changes</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Complete</span>
            </div>
            <div class="state-machine">
                <h3>Approval State Machine</h3>
                <div class="states-grid">
                    <div class="state-box state-initial">pending</div>
                    <div class="state-box state-active">under_review</div>
                    <div class="state-box state-final">approved</div>
                    <div class="state-box state-error">rejected</div>
                    <div class="state-box state-error">expired</div>
                </div>
            </div>
        </div>

        <div id="sync" class="flow-section">
            <div class="flow-header">
                <h2>19. Multi-Clinic Sync Flow</h2>
                <p>Offline-first data synchronization between clinic locations with conflict resolution.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Local Change</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Queue for Sync</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Online?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Push to Central</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Conflict?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Resolve</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Propagate</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Synced</span>
            </div>
        </div>

        <div id="alerts" class="flow-section">
            <div class="flow-header">
                <h2>20. Alert & Notification Flow</h2>
                <p>Clinical alerts, system notifications, and multi-channel delivery (in-app, email, SMS).</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Trigger Event</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Evaluate Rules</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Alert Needed?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Create Alert</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Route to Users</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Multi-Channel Send</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-decision">Acknowledged?</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Resolved</span>
            </div>
            <div class="websocket-events">
                <h3>Alert Events</h3>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">alert:clinical</span><span class="ws-desc">Drug interaction, allergy, critical value</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">alert:system</span><span class="ws-desc">Low stock, expiring items, sync issues</span></div>
                <div class="ws-event"><span class="ws-icon">⚡</span><span class="ws-name">notification:new</span><span class="ws-desc">General notification for user</span></div>
            </div>
        </div>

        <div id="audit" class="flow-section">
            <div class="flow-header">
                <h2>21. Audit Trail Flow</h2>
                <p>Comprehensive logging of all system actions for compliance and forensics.</p>
            </div>
            <div class="mini-flow">
                <span class="mini-step mini-trigger">Any Action</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Middleware Intercept</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Capture Before State</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Execute Action</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Capture After State</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-process">Create AuditLog</span>
                <span class="mini-arrow">→</span>
                <span class="mini-step mini-end">Logged</span>
            </div>
            <div class="flow-diagram">
                <div class="flow-title">Audit Log Data Captured</div>
                <div class="flow-steps">
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">User Context</div>
                            <div class="step-detail">userId, role, clinicId, IP address, user agent</div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Action Details</div>
                            <div class="step-detail">action type, resource, resourceId, method, endpoint</div>
                        </div>
                    </div>
                    <div class="flow-step step-process">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Change Tracking</div>
                            <div class="step-detail">changes.before, changes.after (field-level diff)</div>
                        </div>
                    </div>
                    <div class="flow-step step-end">
                        <div class="step-connector"><div class="step-dot"></div><div class="step-line"></div></div>
                        <div class="step-content">
                            <div class="step-name">Metadata</div>
                            <div class="step-detail">timestamp, duration, success/failure, error details</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showFlow(flowId) {
            document.querySelectorAll('.flow-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(flowId).classList.add('active');
            event.target.classList.add('active');
            window.scrollTo({ top: 200, behavior: 'smooth' });
        }
    </script>
</body>
</html>
